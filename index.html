<!DOCTYPE html>
<html>
<head>
  <title>Admin Panel - Manage Quizzes</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <style>
    body {
      font-family: 'Segoe UI', Roboto, Arial, sans-serif;
      padding: 20px;
      background: #f4f7f6;
      margin: 0;
      color: #333;
    }
    h2, h3 {
      color: #2c3e50;
      margin-top: 0; /* Adjust for tab content */
    }
    h4 {
        margin-top: 15px;
        margin-bottom: 10px;
        color: #34495e;
    }
    input, textarea, button, select {
      display: block;
      width: 100%;
      margin: 10px 0;
      padding: 12px;
      font-size: 16px;
      border-radius: 6px;
      border: 1px solid #ccc;
      box-sizing: border-box;
      transition: border-color 0.3s ease, box-shadow 0.3s ease;
    }
    input:focus, textarea:focus, select:focus {
      border-color: #3498db;
      box-shadow: 0 0 0 2px rgba(52, 152, 219, 0.2);
      outline: none;
    }
    .admin-section-box, .quiz-form-box, .question-block, .existing-quiz-item, .ai-review-item {
      background: #fff;
      padding: 20px;
      margin-bottom: 25px;
      border-radius: 8px;
      box-shadow: 0 4px 8px rgba(0,0,0,0.08);
    }
    .question-block, .ai-review-item {
        padding: 15px;
    }
    .option-input-group {
      display: flex;
      gap: 10px;
      align-items: center;
      margin-bottom: 8px;
    }
    .option-input-group input {
      flex: 1;
      margin: 0;
    }
    .remove-btn {
      background-color: #e74c3c;
      color: #fff;
      border: none;
      padding: 10px 15px;
      border-radius: 5px;
      cursor: pointer;
      font-size: 14px;
      transition: background-color 0.2s ease;
    }
    .remove-btn:hover { background-color: #c0392b; }

    .add-btn, .generate-btn {
      background-color: #3498db;
      color: #fff;
      border: none;
      padding: 12px 20px;
      margin-top: 15px;
      border-radius: 5px;
      font-size: 16px;
      cursor: pointer;
      transition: background-color 0.2s ease;
    }
    .add-btn:hover, .generate-btn:hover { background-color: #2980b9; }
    .add-btn:disabled, .generate-btn:disabled {
      background-color: #bdc3c7;
      cursor: not-allowed;
    }
    .generate-btn { background-color: #2ecc71; }
    .generate-btn:hover { background-color: #27ae60; }

    .form-actions {
        display: flex;
        gap: 10px;
        margin-top: 20px;
    }
    .form-actions button { flex-grow: 1; margin-top: 0; }

    .delete-quiz-btn, .edit-quiz-btn {
      background: #e74c3c; color: white; border: none; padding: 8px 14px;
      border-radius: 4px; cursor: pointer; margin-right: 10px; font-size: 14px;
      transition: background-color 0.2s ease;
    }
    .edit-quiz-btn { background-color: #2ecc71; }
    .delete-quiz-btn:hover { background-color: #c0392b; }
    .edit-quiz-btn:hover { background-color: #27ae60; }

    .accordion-header {
      cursor: pointer; padding: 12px 15px; background: #e9ecef;
      border-radius: 5px; font-weight: bold; display: flex; align-items: center;
      transition: background-color 0.2s ease;
    }
    .accordion-header:hover { background-color: #dee2e6; }
    .accordion-icon { margin-right: 10px; font-size: 1.1em; transition: transform 0.3s ease; }
    .accordion-header.active .accordion-icon { transform: rotate(90deg); }

    .question-content, .ai-review-item-content {
      display: none; padding: 15px; border: 1px solid #e9ecef;
      border-top: none; border-radius: 0 0 5px 5px;
    }
    .ai-review-item-content { display: block; }
    .ai-review-item label, .question-content label {
        font-weight: bold; margin-top: 10px; margin-bottom: 5px; display: block; color: #555;
    }
    .ai-review-item .keep-question-label { display: inline-block; margin-left: 5px; font-weight: normal; }
    .ai-review-item input[type="checkbox"] { width: auto; margin-right: 5px; vertical-align: middle; }
    #ai-destination-options input[type="radio"] { width: auto; margin-right: 5px; vertical-align: middle; }
    #ai-destination-options label { font-weight: normal; margin-top: 0; }
    #ai-destination-options div { margin-bottom:10px; }


    .empty-list-message { text-align: center; color: #777; padding: 20px; font-style: italic; }
    .api-key-warning {
        color: #c0392b; font-weight: bold; background-color: #fceded;
        padding: 10px; border-radius: 5px; margin-bottom: 15px; border: 1px solid #e74c3c;
    }

    /* Tab Styles */
    .tab-navigation {
      border-bottom: 2px solid #ccc;
      margin-bottom: 20px;
      display: flex;
    }
    .tab-button {
      background-color: #f1f1f1;
      border: 1px solid #ccc;
      border-bottom: none;
      padding: 10px 20px;
      cursor: pointer;
      font-size: 16px;
      border-radius: 6px 6px 0 0;
      margin-right: 5px;
      margin-bottom: -1px; /* Overlap border */
      transition: background-color 0.3s ease;
      width: auto; /* Override general button width */
      margin-top: 0; /* Override general button margin */
    }
    .tab-button:hover { background-color: #ddd; }
    .tab-button.active {
      background-color: #fff;
      border-bottom: 2px solid #fff; /* Match background to hide bottom border */
      color: #3498db;
      font-weight: bold;
    }
    .tab-content { display: none; animation: fadeInEffect 0.5s; }
    @keyframes fadeInEffect { from {opacity: 0;} to {opacity: 1;} }


    @media (max-width: 600px) {
      .form-actions { flex-direction: column; }
      .tab-navigation { flex-direction: column; }
      .tab-button { width: 100%; margin-bottom: 5px; border-radius: 6px; }
      .tab-button.active { border-bottom: 1px solid #ccc; }

    }
    .popup-overlay {
        position: fixed; top: 0; left: 0; width: 100%; height: 100%;
        background-color: rgba(0,0,0,0.5); display: none; justify-content: center;
        align-items: center; z-index: 1000;
    }
    .popup-box {
        background: #fff; padding: 25px; border-radius: 8px;
        box-shadow: 0 5px 15px rgba(0,0,0,0.3); text-align: center;
        min-width: 300px; max-width: 90%;
    }
    .popup-box p { margin: 0 0 15px 0; font-size: 16px; }
    .popup-box button {
        background-color: #3498db; color: #fff; border: none; padding: 10px 20px;
        border-radius: 5px; cursor: pointer; font-size: 16px;
        width: auto; /* Override default */
        display: inline-block; /* Override default */
    }
    .popup-box button:hover { background-color: #2980b9; }

    #ai-destination-options {
        margin-top: 20px; padding: 15px; background-color: #e9f5fe;
        border: 1px solid #c5e0f0; border-radius: 6px;
    }
    #ai-destination-options h4 {
        margin-top: 0; margin-bottom: 15px; color: #2c3e50;
    }
    #ai-destination-options label {
      display: inline-block; margin-bottom: 5px; font-weight: 500; margin-right: 15px;
    }
    #ai-destination-options input[type="radio"] {
      width: auto; margin-right: 5px; vertical-align: baseline;
    }
     #ai-destination-options .radio-group { margin-bottom: 10px; }

    #ai-new-quiz-fields input, #ai-new-quiz-fields textarea { margin: 5px 0 10px 0; }
    #ai-existing-quiz-fields select { margin: 5px 0 10px 0; }

  </style>
</head>
<body>

  <div class="tab-navigation">
    <button id="defaultOpenTab" class="tab-button" onclick="openTab(event, 'manualQuizTab')">Manage & Create Quizzes</button>
    <button class="tab-button" onclick="openTab(event, 'aiQuizTab')">AI Quiz Generator</button>
  </div>

  <div id="manualQuizTab" class="tab-content">
    <div class="quiz-form-box">
      <h2 id="form-title">Create New Quiz</h2>
      <input type="text" id="quiz-title" placeholder="Quiz Title" />
      <textarea id="quiz-description" placeholder="Quiz Description" rows="3"></textarea>
      <div id="questions-container">
          </div>
      <button class="add-btn" onclick="addQuestion()">+ Add Manual Question</button>
      <div class="form-actions">
          <button id="submit-quiz-btn" class="add-btn" onclick="submitQuiz()">Save Quiz</button>
          <button id="cancel-edit-btn" class="add-btn" style="display: none; background-color: #7f8c8d;" onclick="cancelEdit()">Cancel Edit</button>
      </div>
    </div>

    <h2>Existing Quizzes</h2>
    <div id="quiz-list"></div>
  </div>

  <div id="aiQuizTab" class="tab-content">
    <div class="admin-section-box">
      <h2>AI Quiz Generator</h2>
      <div class="api-key-warning">
        <strong>Security Warning:</strong> For development/personal use, you can enter your API key below.
        For a production application accessible by others, **never expose your API key directly in client-side code.**
        Use a backend proxy (like Firebase Functions) to handle API calls securely.
        **Do NOT commit your AI API key to version control (Git).**
      </div>
      <label for="ai-api-key">Your AI Model API Key (e.g., Google Gemini API Key):</label>
      <input type="password" id="ai-api-key" placeholder="Paste your AI API Key here" value="AIzaSyDDsqdPO91ylksmvEtQKO6X9MeQgaS0Y20">

      <label for="ai-api-endpoint">AI API Endpoint URL (e.g., for Gemini):</label>
      <input type="text" id="ai-api-endpoint" placeholder="https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent" value="https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=AIzaSyDDsqdPO91ylksmvEtQKO6X9MeQgaS0Y20">

      <label for="ai-quiz-topic">Topic for AI Quiz:</label>
      <input type="text" id="ai-quiz-topic" placeholder="e.g., The Renaissance, Basic Algebra">

      <label for="ai-source-text">Source Text (Optional, but Recommended for better results):</label>
      <textarea id="ai-source-text" rows="5" placeholder="Paste an article or notes for the AI to base questions on..."></textarea>

      <label for="ai-num-questions">Number of Questions to Generate:</label>
      <input type="number" id="ai-num-questions" value="5" min="1" max="15">
      <button id="generate-ai-quiz-btn" class="generate-btn" onclick="generateAIQuiz()">Generate Quiz with AI</button>

      <div id="ai-review-container" style="margin-top: 20px;">
        </div>

      <div id="ai-destination-options" style="display:none;">
        <h4>Where to save these AI questions?</h4>
        <div class="radio-group">
            <input type="radio" name="aiQuizDestination" id="ai-create-new-quiz-radio" value="new" checked onchange="toggleAIDestinationFields()">
            <label for="ai-create-new-quiz-radio">Create a New Quiz</label>
        </div>
        <div id="ai-new-quiz-fields">
          <label for="ai-new-quiz-title">New Quiz Title:</label>
          <input type="text" id="ai-new-quiz-title" placeholder="Enter title for the new AI-generated quiz">
          <label for="ai-new-quiz-description">New Quiz Description:</label>
          <textarea id="ai-new-quiz-description" rows="2" placeholder="Enter description for the new quiz"></textarea>
        </div>
        <div class="radio-group">
            <input type="radio" name="aiQuizDestination" id="ai-add-to-existing-quiz-radio" value="existing" onchange="toggleAIDestinationFields()">
            <label for="ai-add-to-existing-quiz-radio">Add to an Existing Quiz</label>
        </div>
        <div id="ai-existing-quiz-fields" style="display:none;">
          <label for="ai-existing-quiz-select">Select Quiz:</label>
          <select id="ai-existing-quiz-select">
            <option value="">-- Select an Existing Quiz --</option>
          </select>
        </div>
      </div>
      <button id="process-approved-ai-btn" class="add-btn" style="display:none; margin-top:10px;" onclick="handleApprovedAIQuestions()">Process Approved Questions</button>
    </div>
  </div>


  <div id="custom-popup" class="popup-overlay">
    <div class="popup-box">
      <p id="popup-message">Popup Message</p>
      <button onclick="closePopup()">OK</button>
    </div>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.7.1/firebase-app.js";
    import {
      getFirestore, collection, addDoc, deleteDoc,
      doc, getDoc, getDocs, updateDoc
    } from "https://www.gstatic.com/firebasejs/11.7.1/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyDm788npk4qw9RcT7qevq2HPH5-DbSTq2k", // Replace with your actual Firebase API key
      authDomain: "location-45133.firebaseapp.com",
      projectId: "location-45133",
      storageBucket: "location-45133.appspot.com",
      messagingSenderId: "938504563570",
      appId: "1:938504563570:web:a4741a9f52b9795f304beb"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    // DOM Elements for Manual Quiz Form
    const questionsContainer = document.getElementById("questions-container");
    const titleInput = document.getElementById("quiz-title");
    const descInput = document.getElementById("quiz-description");
    const formTitle = document.getElementById("form-title");
    const submitQuizBtn = document.getElementById("submit-quiz-btn");
    const cancelEditBtn = document.getElementById("cancel-edit-btn");
    const quizListDiv = document.getElementById("quiz-list");

    // DOM Elements for AI Quiz Generator
    const aiApiKeyInput = document.getElementById("ai-api-key");
    const aiApiEndpointInput = document.getElementById("ai-api-endpoint");
    const aiQuizTopicInput = document.getElementById("ai-quiz-topic");
    const aiSourceTextInput = document.getElementById("ai-source-text");
    const aiNumQuestionsInput = document.getElementById("ai-num-questions");
    const generateAIQuizBtn = document.getElementById("generate-ai-quiz-btn");
    const aiReviewContainer = document.getElementById("ai-review-container");
    const processApprovedAIBtn = document.getElementById("process-approved-ai-btn");
    const aiDestinationOptionsDiv = document.getElementById("ai-destination-options");
    const aiNewQuizFieldsDiv = document.getElementById("ai-new-quiz-fields");
    const aiExistingQuizFieldsDiv = document.getElementById("ai-existing-quiz-fields");
    const aiNewQuizTitleInput = document.getElementById("ai-new-quiz-title");
    const aiNewQuizDescInput = document.getElementById("ai-new-quiz-description");
    const aiExistingQuizSelect = document.getElementById("ai-existing-quiz-select");


    let editingQuizId = null;
    let questionCounter = 0;

    // --- Tab Navigation ---
    window.openTab = function(evt, tabName) {
      let i, tabcontent, tabbuttons;
      tabcontent = document.getElementsByClassName("tab-content");
      for (i = 0; i < tabcontent.length; i++) {
        tabcontent[i].style.display = "none";
      }
      tabbuttons = document.getElementsByClassName("tab-button");
      for (i = 0; i < tabbuttons.length; i++) {
        tabbuttons[i].className = tabbuttons[i].className.replace(" active", "");
      }
      document.getElementById(tabName).style.display = "block";
      if (evt && evt.currentTarget) evt.currentTarget.className += " active";
      else if (evt === null && tabName === 'manualQuizTab') { // Programmatic switch
          document.getElementById('defaultOpenTab').className += " active";
      }
    }
    document.getElementById("defaultOpenTab").click();


    // --- AI Quiz Generation Functions ---
    window.generateAIQuiz = async function() {
        const apiKey = aiApiKeyInput.value.trim();
        const apiEndpoint = aiApiEndpointInput.value.trim();
        const topic = aiQuizTopicInput.value.trim();
        const sourceText = aiSourceTextInput.value.trim();
        const numQuestions = parseInt(aiNumQuestionsInput.value, 10);

        if (apiKey === "YOUR_GEMINI_API_KEY_HERE" || !apiKey) { showPopup("Please enter your actual AI Model API Key."); return; }
        if (!apiEndpoint) { showPopup("Please enter the AI API Endpoint URL."); return; }
        if (!topic) { showPopup("Please enter a topic for the AI quiz."); return; }
        if (isNaN(numQuestions) || numQuestions < 1 || numQuestions > 15) {
            showPopup("Please enter a valid number of questions (1-15)."); return;
        }

        generateAIQuizBtn.disabled = true;
        generateAIQuizBtn.textContent = "Generating... Please Wait...";
        aiReviewContainer.innerHTML = '<p>Generating questions with AI... This may take a moment.</p>';
        processApprovedAIBtn.style.display = "none";
        aiDestinationOptionsDiv.style.display = "none";

        let promptText = `Generate ${numQuestions} unique multiple-choice quiz questions about the topic: "${topic}".
Each question should have exactly 4 distinct options.
Clearly indicate the single correct answer for each question.
Provide the output as a valid JSON array of objects. Each object in the array should represent a single question and have the following keys:
- "questionText": A string containing the question.
- "options": An array of 4 unique string options.
- "correctAnswer": A string that exactly matches one of the provided options.

Example of one object in the JSON array:
{
  "questionText": "What is the capital of France?",
  "options": ["Paris", "London", "Berlin", "Rome"],
  "correctAnswer": "Paris"
}`;
        if (sourceText) {
            promptText += `\n\nBase the questions on the following text if possible:\n"${sourceText}"`;
        }

        let finalApiEndpoint = apiEndpoint;

        try {
            const requestBody = {
                "contents": [{"parts": [{"text": promptText}]}],
                "generationConfig": {"temperature": 0.7, "maxOutputTokens": 2048 }
            };

            const response = await fetch(finalApiEndpoint, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json', 'x-goog-api-key': apiKey },
                body: JSON.stringify(requestBody)
            });

            if (!response.ok) {
                const errorData = await response.json().catch(() => response.text());
                console.error("AI API Error Response:", errorData);
                throw new Error(`AI API request failed: ${response.status} ${response.statusText}.`);
            }

            const data = await response.json();
            const generatedQuestions = parseGeminiAIResponse(data);

            if (generatedQuestions && generatedQuestions.length > 0) {
                displayAIQuestionsForReview(generatedQuestions);
                await populateExistingQuizzesDropdown(); // Populate dropdown for "add to existing"
                aiDestinationOptionsDiv.style.display = "block";
                processApprovedAIBtn.style.display = "block";
                toggleAIDestinationFields(); // Ensure correct fields are shown based on default radio
            } else {
                aiReviewContainer.innerHTML = '<p style="color: orange;">AI did not return questions in the expected format, or returned no questions. Check console for API response.</p>';
                console.warn("Raw AI Response:", data);
            }

        } catch (error) {
            console.error('Error generating AI quiz:', error);
            showPopup(`Error generating quiz with AI: ${error.message}. Check console for details.`);
            aiReviewContainer.innerHTML = `<p style="color: red;">Error during AI generation. Check console.</p>`;
        } finally {
            generateAIQuizBtn.disabled = false;
            generateAIQuizBtn.textContent = "Generate Quiz with AI";
        }
    };

    function parseGeminiAIResponse(apiResponse) {
        try {
            if (apiResponse.candidates && apiResponse.candidates[0] &&
                apiResponse.candidates[0].content && apiResponse.candidates[0].content.parts &&
                apiResponse.candidates[0].content.parts[0] && apiResponse.candidates[0].content.parts[0].text) {

                let jsonString = apiResponse.candidates[0].content.parts[0].text;
                jsonString = jsonString.replace(/^```json\s*|```\s*$/g, '').trim();

                const parsedJson = JSON.parse(jsonString);
                if (Array.isArray(parsedJson)) {
                    return parsedJson.map(q => ({
                        questionText: q.questionText || q.question || "",
                        options: Array.isArray(q.options) && q.options.length === 4 ? q.options : ["", "", "", ""],
                        correctAnswer: q.correctAnswer || q.answer || ""
                    })).filter(q => q.questionText && q.options.every(opt => opt !== undefined) && q.correctAnswer); // Basic validation
                }
            }
            console.error("Could not find expected JSON structure in AI response:", apiResponse);
            return [];
        } catch (e) {
            console.error("Error parsing JSON from AI response:", e, "Raw text:", apiResponse?.candidates?.[0]?.content?.parts?.[0]?.text);
            showPopup("AI returned data, but it was not in the expected JSON format. See console for details.");
            return [];
        }
    }

    function displayAIQuestionsForReview(questions) {
        aiReviewContainer.innerHTML = '<h3>Review AI-Generated Questions:</h3> <p>Edit as needed and check "Keep" for questions to use.</p>';
        questions.forEach((q, index) => {
            const reviewItemId = `ai-q-${index}`;
            const itemDiv = document.createElement('div');
            itemDiv.className = 'ai-review-item';
            itemDiv.id = reviewItemId;
            const uniqueSelectId = `ai-answer-select-${index}`;

            itemDiv.innerHTML = `
                <h4>Question ${index + 1} (AI Generated)</h4>
                <div class="ai-review-item-content">
                    <label for="${reviewItemId}-text">Question Text:</label>
                    <input type="text" id="${reviewItemId}-text" class="ai-q-text" value="${q.questionText || ''}">
                    <label>Options:</label>
                    ${(q.options || ["","","",""]).map((opt, optIndex) => `
                        <div class="option-input-group">
                            <input type="text" class="ai-q-option" value="${opt || ''}" placeholder="Option ${optIndex + 1}" oninput="updateAnswerDropdown(this.closest('.ai-review-item'))">
                        </div>
                    `).join('')}
                    <label for="${uniqueSelectId}">Correct Answer:</label>
                    <select class="ai-q-answer answer-select" id="${uniqueSelectId}"> <option value="">-- Select --</option></select>
                    <input type="checkbox" id="${reviewItemId}-keep" class="ai-q-keep" checked>
                    <label for="${reviewItemId}-keep" class="keep-question-label">Keep this question</label>
                </div>`;
            aiReviewContainer.appendChild(itemDiv);
            updateAnswerDropdown(itemDiv); // Populate dropdown
            const answerSelect = itemDiv.querySelector('.answer-select');
             // Try to set the correct answer, ensuring it exists in the options
            const trimmedCorrectAnswer = q.correctAnswer.trim();
            const trimmedOptions = (q.options || []).map(o => o.trim());
            if (trimmedCorrectAnswer && trimmedOptions.includes(trimmedCorrectAnswer)) {
                 answerSelect.value = trimmedCorrectAnswer;
            } else if (q.correctAnswer) { // If AI gave an answer, but it's not in options
                // Add it as a new option and select it, or warn user
                const newOpt = document.createElement('option');
                newOpt.value = trimmedCorrectAnswer;
                newOpt.textContent = trimmedCorrectAnswer + " (AI's original answer)";
                // answerSelect.appendChild(newOpt); // Decide if you want to auto-add
                // answerSelect.value = trimmedCorrectAnswer;
                console.warn(`AI answer "${q.correctAnswer}" for Q${index+1} not found in its provided options. Manual selection might be needed.`);
            }
        });
    }

    async function populateExistingQuizzesDropdown() {
        aiExistingQuizSelect.innerHTML = '<option value="">-- Select an Existing Quiz --</option>'; // Reset
        try {
            const querySnapshot = await getDocs(collection(db, "quizzes"));
            if (querySnapshot.empty) {
                const option = document.createElement('option');
                option.value = "";
                option.textContent = "No existing quizzes found";
                option.disabled = true;
                aiExistingQuizSelect.appendChild(option);
                // Disable "add to existing" if no quizzes
                document.getElementById('ai-add-to-existing-quiz-radio').disabled = true;
                if (document.getElementById('ai-add-to-existing-quiz-radio').checked) {
                    document.getElementById('ai-create-new-quiz-radio').checked = true;
                    toggleAIDestinationFields();
                }
            } else {
                 document.getElementById('ai-add-to-existing-quiz-radio').disabled = false;
                querySnapshot.forEach(docSnap => {
                    const quiz = docSnap.data();
                    const option = document.createElement('option');
                    option.value = docSnap.id;
                    option.textContent = quiz.title || "Untitled Quiz";
                    aiExistingQuizSelect.appendChild(option);
                });
            }
        } catch (error) {
            console.error("Error loading existing quizzes for dropdown:", error);
            showPopup("Could not load existing quizzes for AI options.");
        }
    }

    window.toggleAIDestinationFields = function() {
        if (document.getElementById('ai-create-new-quiz-radio').checked) {
            aiNewQuizFieldsDiv.style.display = "block";
            aiExistingQuizFieldsDiv.style.display = "none";
        } else {
            aiNewQuizFieldsDiv.style.display = "none";
            aiExistingQuizFieldsDiv.style.display = "block";
        }
    }

    window.handleApprovedAIQuestions = async function() {
        const reviewItems = aiReviewContainer.querySelectorAll('.ai-review-item');
        const approvedQuestions = [];
        reviewItems.forEach((item, index) => {
            const keepCheckbox = item.querySelector('.ai-q-keep');
            if (keepCheckbox && keepCheckbox.checked) {
                const questionText = item.querySelector('.ai-q-text').value.trim();
                const options = Array.from(item.querySelectorAll('.ai-q-option')).map(opt => opt.value.trim());
                const correctAnswer = item.querySelector('.ai-q-answer').value;

                if (!questionText || options.some(o => !o) || options.length !== 4 || !correctAnswer) {
                    showPopup(`Skipping incompletely reviewed AI question ${index + 1}. All fields and correct answer must be set.`);
                    return; // Skip this question but continue processing others
                }
                approvedQuestions.push({ question: questionText, options: options, answer: correctAnswer });
            }
        });

        if (approvedQuestions.length === 0) {
            showPopup("No AI-generated questions were marked to be kept or none were complete.");
            return;
        }

        const destination = document.querySelector('input[name="aiQuizDestination"]:checked').value;
        processApprovedAIBtn.disabled = true;
        processApprovedAIBtn.textContent = "Processing...";

        try {
            if (destination === "new") {
                const newTitle = aiNewQuizTitleInput.value.trim();
                const newDescription = aiNewQuizDescInput.value.trim();
                if (!newTitle) {
                    showPopup("Please enter a title for the new AI-generated quiz.");
                    return;
                }
                if (!newDescription) {
                    showPopup("Please enter a description for the new AI-generated quiz.");
                    return;
                }
                await addDoc(collection(db, "quizzes"), {
                    title: newTitle,
                    description: newDescription,
                    questions: approvedQuestions
                });
                showPopup(`Successfully created new quiz "${newTitle}" with ${approvedQuestions.length} AI question(s).`);
                aiNewQuizTitleInput.value = "";
                aiNewQuizDescInput.value = "";

            } else if (destination === "existing") {
                const selectedQuizId = aiExistingQuizSelect.value;
                if (!selectedQuizId) {
                    showPopup("Please select an existing quiz to add questions to.");
                    return;
                }
                const quizDocRef = doc(db, "quizzes", selectedQuizId);
                const quizDocSnap = await getDoc(quizDocRef);

                if (!quizDocSnap.exists()) {
                    showPopup("Error: Selected existing quiz not found.");
                    return;
                }
                const existingData = quizDocSnap.data();
                const combinedQuestions = [...(existingData.questions || []), ...approvedQuestions];
                await updateDoc(quizDocRef, { questions: combinedQuestions });
                showPopup(`Successfully added ${approvedQuestions.length} AI question(s) to quiz "${existingData.title}".`);
            }
            // Cleanup after successful operation
            aiReviewContainer.innerHTML = "";
            aiDestinationOptionsDiv.style.display = "none";
            processApprovedAIBtn.style.display = "none";
            loadQuizzes(); // Refresh the main quiz list

        } catch (error) {
            console.error("Error processing approved AI questions:", error);
            showPopup("Error saving AI questions: " + error.message);
        } finally {
            processApprovedAIBtn.disabled = false;
            processApprovedAIBtn.textContent = "Process Approved Questions";
        }
    };


    // --- Manual Quiz Form Functions ---
    window.updateAnswerDropdown = function (questionBlockContainer) { // Made window. for oninput
        const optionInputs = questionBlockContainer.querySelectorAll(".option, .ai-q-option");
        const answerSelect = questionBlockContainer.querySelector(".answer-select, .ai-q-answer");
        if (!answerSelect) return;

        const previouslySelectedAnswer = answerSelect.value;
        answerSelect.innerHTML = '<option value="">-- Select Correct Answer --</option>';
        let anOptionMatchedPrevious = false;

        optionInputs.forEach(optInput => {
            const optText = optInput.value.trim();
            if (optText) {
                const optionElement = document.createElement("option");
                optionElement.value = optText;
                optionElement.textContent = optText;
                answerSelect.appendChild(optionElement);
                if (optText === previouslySelectedAnswer) {
                    optionElement.selected = true;
                    anOptionMatchedPrevious = true;
                }
            }
        });
        if (anOptionMatchedPrevious) {
            answerSelect.value = previouslySelectedAnswer;
        } else {
            answerSelect.value = "";
        }
    }

    window.addQuestion = function () {
      questionCounter++;
      const questionNumberInUI = questionsContainer.children.length + 1;
      const div = document.createElement("div");
      div.className = "question-block";
      div.id = `question-manual-${questionCounter}`;
      const header = document.createElement("div");
      header.className = "accordion-header";
      header.innerHTML = `<span class="accordion-icon" style="transform: rotate(0deg);">â–º</span> Question ${questionNumberInUI}`;
      const content = document.createElement("div");
      content.className = "question-content";
      content.innerHTML = `
        <input type="text" class="question-text" placeholder="Enter question">
        <label>Options (Enter text for each):</label>
        <div class="option-input-group"><input type="text" placeholder="Option A" class="option" oninput="updateAnswerDropdown(this.closest('.question-block'))"></div>
        <div class="option-input-group"><input type="text" placeholder="Option B" class="option" oninput="updateAnswerDropdown(this.closest('.question-block'))"></div>
        <div class="option-input-group"><input type="text" placeholder="Option C" class="option" oninput="updateAnswerDropdown(this.closest('.question-block'))"></div>
        <div class="option-input-group"><input type="text" placeholder="Option D" class="option" oninput="updateAnswerDropdown(this.closest('.question-block'))"></div>
        <label for="answer-select-manual-${questionCounter}">Correct Answer:</label>
        <select class="answer-select" id="answer-select-manual-${questionCounter}">
            <option value="">-- Select Correct Answer --</option>
        </select>
        <button class="remove-btn" onclick="removeQuestionBlock(this)">Remove Question</button>`;
      header.addEventListener("click", () => {
        const isActive = header.classList.toggle("active");
        content.style.display = isActive ? "block" : "none";
        header.querySelector('.accordion-icon').style.transform = isActive ? "rotate(90deg)" : "rotate(0deg)";
      });
      div.appendChild(header);
      div.appendChild(content);
      questionsContainer.appendChild(div);
      content.style.display = "block";
      header.classList.add("active");
      header.querySelector('.accordion-icon').style.transform = "rotate(90deg)";
      updateAnswerDropdown(div);
    };

    window.removeQuestionBlock = function(buttonEl) {
        buttonEl.closest('.question-block').remove();
        const qBlocks = questionsContainer.querySelectorAll('.question-block');
        qBlocks.forEach((block, index) => {
            const header = block.querySelector('.accordion-header');
            const iconSpan = header.querySelector('.accordion-icon');
            const currentIconTransform = iconSpan.style.transform;
            header.childNodes[1].nodeValue = ` Question ${index + 1}`; // Update text node directly
        });
    }

    function clearForm() {
      titleInput.value = ""; descInput.value = ""; questionsContainer.innerHTML = "";
      editingQuizId = null; formTitle.textContent = "Create New Quiz";
      submitQuizBtn.textContent = "Save Quiz"; cancelEditBtn.style.display = "none";
      questionCounter = 0;
      // Clear AI form elements potentially related to manual form interaction (none directly now)
      aiReviewContainer.innerHTML = "";
      aiDestinationOptionsDiv.style.display = "none";
      processApprovedAIBtn.style.display = "none";
      // aiQuizTopicInput.value = ""; aiSourceTextInput.value = ""; // Optionally clear these
    }

    window.cancelEdit = function() { clearForm(); }

    window.submitQuiz = async function () {
      const title = titleInput.value.trim();
      const description = descInput.value.trim();
      const questionBlocks = questionsContainer.querySelectorAll(".question-block");

      if (!title) { showPopup("Please enter a quiz title."); return; }
      if (!description) { showPopup("Please enter a quiz description."); return; }
      if (questionBlocks.length === 0) { showPopup("Please add at least one question to the quiz form."); return; }

      const questions = [];
      for (let i = 0; i < questionBlocks.length; i++) {
        const block = questionBlocks[i];
        const qText = block.querySelector(".question-text").value.trim();
        const opts = Array.from(block.querySelectorAll(".option")).map(o => o.value.trim());
        const ans = block.querySelector(".answer-select").value;
        const questionNumberForError = i + 1;
        if (!qText) { showPopup(`Question text missing in Question ${questionNumberForError} of the form.`); return; }
        if (opts.some(o => !o) || opts.length !== 4) { showPopup(`All 4 options required for Question ${questionNumberForError} of the form.`); return; }
        if (!ans) { showPopup(`Correct answer not selected for Question ${questionNumberForError} of the form.`); return; }
        questions.push({ question: qText, options: opts, answer: ans });
      }

      const originalButtonText = submitQuizBtn.textContent;
      submitQuizBtn.disabled = true;
      submitQuizBtn.textContent = editingQuizId ? 'Updating...' : 'Saving...';

      try {
        if (editingQuizId) {
          await updateDoc(doc(db, "quizzes", editingQuizId), { title, description, questions });
          showPopup("Quiz updated successfully!");
        } else {
          await addDoc(collection(db, "quizzes"), { title, description, questions });
          showPopup("Quiz added successfully!");
        }
        clearForm();
        loadQuizzes();
      } catch (e) {
        console.error("Error saving quiz:", e);
        showPopup("Error saving quiz: " + e.message);
      } finally {
        submitQuizBtn.disabled = false;
        // Use the form title to determine button text, as editingQuizId might be cleared
        submitQuizBtn.textContent = document.getElementById("form-title").textContent === "Edit Quiz" ? "Update Quiz" : "Save Quiz";
      }
    };

    async function loadQuizzes() {
      quizListDiv.innerHTML = "";
      try {
        const querySnapshot = await getDocs(collection(db, "quizzes"));
        if (querySnapshot.empty) {
            quizListDiv.innerHTML = '<p class="empty-list-message">No quizzes found. Start by creating a new one!</p>';
            return;
        }
        querySnapshot.forEach(docSnap => {
          const data = docSnap.data();
          const quizDiv = document.createElement("div");
          quizDiv.className = "existing-quiz-item";
          quizDiv.innerHTML = `
            <h3>${data.title}</h3>
            <p>${data.description ? data.description.substring(0,100) : ''}${data.description && data.description.length > 100 ? '...' : ''}</p>
            <p><strong>${data.questions ? data.questions.length : 0}</strong> question(s)</p>
            <div>
                <button class="edit-quiz-btn" onclick="editQuiz('${docSnap.id}')">Edit</button>
                <button class="delete-quiz-btn" onclick="deleteQuiz('${docSnap.id}')">Delete</button>
            </div>`;
          quizListDiv.appendChild(quizDiv);
        });
      } catch (error) {
          console.error("Error loading quizzes:", error);
          quizListDiv.innerHTML = '<p class="empty-list-message" style="color: red;">Could not load quizzes.</p>';
      }
    }

    window.deleteQuiz = async function (id) {
      if (confirm("Are you sure you want to delete this quiz? This action cannot be undone.")) {
        try {
            await deleteDoc(doc(db, "quizzes", id));
            showPopup("Quiz deleted successfully.");
            loadQuizzes();
            if (editingQuizId === id) { clearForm(); } // If deleting the quiz being edited, clear form
        } catch (error) {
            console.error("Error deleting quiz:", error);
            showPopup("Error deleting quiz: " + error.message);
        }
      }
    };

    window.editQuiz = async function (id) {
      openTab(null, 'manualQuizTab');
      const formBox = document.querySelector('.quiz-form-box');
      if (formBox) formBox.scrollIntoView({ behavior: 'smooth' });

      // Clear any pending AI review stuff if user clicks edit on manual tab
      aiReviewContainer.innerHTML = "";
      aiDestinationOptionsDiv.style.display = "none";
      processApprovedAIBtn.style.display = "none";

      try {
        const quizDocRef = doc(db, "quizzes", id);
        const quizDoc = await getDoc(quizDocRef);
        if (!quizDoc.exists()) {
            showPopup("Quiz not found. It might have been deleted.");
            loadQuizzes(); // Refresh list
            clearForm(); // Clear form as the quiz is gone
            return;
        }

        editingQuizId = id;
        formTitle.textContent = "Edit Quiz";
        submitQuizBtn.textContent = "Update Quiz";
        cancelEditBtn.style.display = "inline-block";

        const data = quizDoc.data();
        titleInput.value = data.title || ""; descInput.value = data.description || "";
        questionsContainer.innerHTML = ""; questionCounter = 0; // Reset for new questions

        if (data.questions && Array.isArray(data.questions)) {
            data.questions.forEach((q) => {
              window.addQuestion(); // This increments questionCounter and creates block
              const newQuestionBlocks = questionsContainer.querySelectorAll('.question-block');
              const targetBlock = newQuestionBlocks[newQuestionBlocks.length - 1]; // Get the last added block
              if(targetBlock){
                  targetBlock.querySelector('.question-text').value = q.question || '';
                  const optionInputs = targetBlock.querySelectorAll('.option');
                  const formOptions = q.options && q.options.length === 4 ? q.options : ["", "", "", ""];
                  optionInputs.forEach((input, i) => input.value = formOptions[i] || '');

                  updateAnswerDropdown(targetBlock); // Populate and set correct answer
                  const answerSelect = targetBlock.querySelector('.answer-select');
                  answerSelect.value = q.answer || "";
                  if (!answerSelect.value && q.answer) {
                      console.warn(`Loaded answer "${q.answer}" for Q "${q.question}" not found in options after populating dropdown.`);
                  }
                  
                  const qContent = targetBlock.querySelector('.question-content');
                  const qHeader = targetBlock.querySelector('.accordion-header');
                  const qIcon = qHeader.querySelector('.accordion-icon');
                  // Collapse all but the first question when editing for tidiness
                  if (questionsContainer.children.length > 1) {
                    qContent.style.display = "none";
                    qHeader.classList.remove('active');
                    if(qIcon) qIcon.style.transform = "rotate(0deg)";
                  } else { // Keep first expanded
                    qContent.style.display = "block";
                    qHeader.classList.add('active');
                    if(qIcon) qIcon.style.transform = "rotate(90deg)";
                  }
              }
            });
        }
      } catch (error) {
          console.error("Error loading quiz for editing:", error);
          showPopup("Could not load quiz for editing: " + error.message);
          clearForm(); // Reset form on error
      }
    };

    window.showPopup = function(message) {
      document.getElementById("popup-message").innerText = message;
      document.getElementById("custom-popup").style.display = "flex";
    };
    window.closePopup = function() {
      document.getElementById("custom-popup").style.display = "none";
    };

    // Initial load
    loadQuizzes();
    toggleAIDestinationFields(); // Set initial state for AI destination fields
  </script>
</body>
</html>
