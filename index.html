<!DOCTYPE html>
<html>
<head>
  <title>Admin Panel - Manage Quizzes</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <style>
    body {
      font-family: 'Segoe UI', Roboto, Arial, sans-serif;
      padding: 20px;
      background: #f4f7f6;
      margin: 0;
      color: #333;
    }
    h2, h3 {
      color: #2c3e50;
      margin-top: 0; /* Adjust for tab content */
    }
    h4 {
        margin-top: 15px;
        margin-bottom: 10px;
        color: #34495e;
    }
    input, textarea, button, select {
      display: block;
      width: 100%;
      margin: 10px 0;
      padding: 12px;
      font-size: 16px;
      border-radius: 6px;
      border: 1px solid #ccc;
      box-sizing: border-box;
      transition: border-color 0.3s ease, box-shadow 0.3s ease;
    }
    input:focus, textarea:focus, select:focus {
      border-color: #3498db;
      box-shadow: 0 0 0 2px rgba(52, 152, 219, 0.2);
      outline: none;
    }
    label {
        font-weight: 500;
        margin-bottom: 3px;
        display: block;
        color: #333;
    }
    .admin-section-box, .quiz-form-box, .question-block, .existing-quiz-item, .ai-review-item, .category-form-box, .category-list-item {
      background: #fff;
      padding: 20px;
      margin-bottom: 25px;
      border-radius: 8px;
      box-shadow: 0 4px 8px rgba(0,0,0,0.08);
    }
    .question-block, .ai-review-item, .category-list-item {
        padding: 15px;
    }
    .category-list-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 10px;
    }
    .category-list-item div button { margin-left: 10px; width: auto;}


    .option-input-group { display: flex; gap: 10px; align-items: center; margin-bottom: 8px; }
    .option-input-group input { flex: 1; margin: 0; }

    .remove-btn, .delete-category-btn {
      background-color: #e74c3c; color: #fff; border: none; padding: 10px 15px;
      border-radius: 5px; cursor: pointer; font-size: 14px; transition: background-color 0.2s ease;
    }
    .remove-btn:hover, .delete-category-btn:hover { background-color: #c0392b; }

    .add-btn, .generate-btn, .save-category-btn {
      background-color: #3498db; color: #fff; border: none; padding: 12px 20px;
      margin-top: 15px; border-radius: 5px; font-size: 16px; cursor: pointer;
      transition: background-color 0.2s ease;
    }
    .add-btn:hover, .generate-btn:hover, .save-category-btn:hover { background-color: #2980b9; }
    .add-btn:disabled, .generate-btn:disabled, .save-category-btn:disabled { background-color: #bdc3c7; cursor: not-allowed; }
    .generate-btn { background-color: #2ecc71; }
    .generate-btn:hover { background-color: #27ae60; }

    .form-actions { display: flex; gap: 10px; margin-top: 20px; }
    .form-actions button { flex-grow: 1; margin-top: 0; }

    .edit-quiz-btn, .edit-category-btn {
      background: #2ecc71; color: white; border: none; padding: 8px 14px;
      border-radius: 4px; cursor: pointer; margin-right: 10px; font-size: 14px;
      transition: background-color 0.2s ease;
    }
    .edit-quiz-btn:hover, .edit-category-btn:hover { background-color: #27ae60; }


    .accordion-header { cursor: pointer; padding: 12px 15px; background: #e9ecef; border-radius: 5px; font-weight: bold; display: flex; align-items: center; transition: background-color 0.2s ease; }
    .accordion-header:hover { background-color: #dee2e6; }
    .accordion-icon { margin-right: 10px; font-size: 1.1em; transition: transform 0.3s ease; }
    .accordion-header.active .accordion-icon { transform: rotate(90deg); }

    .question-content, .ai-review-item-content { display: none; padding: 15px; border: 1px solid #e9ecef; border-top: none; border-radius: 0 0 5px 5px; }
    .ai-review-item-content { display: block; }
    .ai-review-item label, .question-content label { font-weight: bold; margin-top: 10px; margin-bottom: 5px; display: block; color: #555; }
    .ai-review-item .keep-question-label { display: inline-block; margin-left: 5px; font-weight: normal; }
    .ai-review-item input[type="checkbox"] { width: auto; margin-right: 5px; vertical-align: middle; }
    #ai-destination-options input[type="radio"] { width: auto; margin-right: 5px; vertical-align: middle; }
    #ai-destination-options label { font-weight: normal; margin-top: 0; }
    #ai-destination-options div { margin-bottom:10px; }


    .empty-list-message { text-align: center; color: #777; padding: 20px; font-style: italic; }
    .api-key-warning { color: #c0392b; font-weight: bold; background-color: #fceded; padding: 10px; border-radius: 5px; margin-bottom: 15px; border: 1px solid #e74c3c; }

    /* Tab Styles */
    .tab-navigation { border-bottom: 2px solid #ccc; margin-bottom: 20px; display: flex; }
    .tab-button { background-color: #f1f1f1; border: 1px solid #ccc; border-bottom: none; padding: 10px 20px; cursor: pointer; font-size: 16px; border-radius: 6px 6px 0 0; margin-right: 5px; margin-bottom: -1px; transition: background-color 0.3s ease; width: auto; margin-top: 0; }
    .tab-button:hover { background-color: #ddd; }
    .tab-button.active { background-color: #fff; border-bottom: 2px solid #fff; color: #3498db; font-weight: bold; }
    .tab-content { display: none; animation: fadeInEffect 0.5s; }
    @keyframes fadeInEffect { from {opacity: 0;} to {opacity: 1;} }


    @media (max-width: 600px) {
      .form-actions { flex-direction: column; }
      .tab-navigation { flex-direction: column; }
      .tab-button { width: 100%; margin-bottom: 5px; border-radius: 6px; }
      .tab-button.active { border-bottom: 1px solid #ccc; }
    }
    .popup-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5); display: none; justify-content: center; align-items: center; z-index: 1000; }
    .popup-box { background: #fff; padding: 25px; border-radius: 8px; box-shadow: 0 5px 15px rgba(0,0,0,0.3); text-align: center; min-width: 300px; max-width: 90%; }
    .popup-box p { margin: 0 0 15px 0; font-size: 16px; }
    .popup-box button { background-color: #3498db; color: #fff; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer; font-size: 16px; width: auto; display: inline-block; }
    .popup-box button:hover { background-color: #2980b9; }

    #ai-destination-options { margin-top: 20px; padding: 15px; background-color: #e9f5fe; border: 1px solid #c5e0f0; border-radius: 6px; }
    #ai-destination-options h4 { margin-top: 0; margin-bottom: 15px; color: #2c3e50; }
    #ai-destination-options label { display: inline-block; margin-bottom: 5px; font-weight: 500; margin-right: 15px; }
    #ai-destination-options input[type="radio"] { width: auto; margin-right: 5px; vertical-align: baseline; }
    #ai-destination-options .radio-group { margin-bottom: 10px; }
    #ai-new-quiz-fields input, #ai-new-quiz-fields textarea { margin: 5px 0 10px 0; }
    #ai-existing-quiz-fields select { margin: 5px 0 10px 0; }

  </style>
</head>
<body>

  <div class="tab-navigation">
    <button id="defaultOpenTab" class="tab-button" onclick="openTab(event, 'manualQuizTab')">Manage Quizzes & Categories</button>
    <button class="tab-button" onclick="openTab(event, 'aiQuizTab')">AI Quiz Generator</button>
  </div>

  <div id="manualQuizTab" class="tab-content">
    <div class="admin-section-box">
        <h2 id="category-form-title">Manage Categories</h2>
        <div class="category-form-box">
            <input type="hidden" id="category-id"> <label for="category-name">Category Name:</label>
            <input type="text" id="category-name" placeholder="e.g., Science, History">
            <label for="category-icon-class">Icon Class (Optional, e.g., Font Awesome):</label>
            <input type="text" id="category-icon-class" placeholder="e.g., fas fa-flask">
            <label for="category-image-url">Image URL (Optional):</label>
            <input type="text" id="category-image-url" placeholder="https://example.com/icon.png">
            <label for="category-color">Background Color (Optional, Hex e.g., #3498db):</label>
            <input type="text" id="category-color" placeholder="#3498db">
            <label for="category-order">Display Order (Optional, Number - for User Panel sorting):</label>
            <input type="number" id="category-order" placeholder="e.g., 1, 2, 3...">
            <div class="form-actions">
                <button id="save-category-btn" class="save-category-btn" onclick="saveCategory()">Save Category</button>
                <button id="clear-category-form-btn" class="add-btn" style="background-color: #95a5a6;" onclick="clearCategoryForm()">Clear Form</button>
            </div>
        </div>
        <h3>Existing Categories</h3>
        <div id="category-list">
            </div>
    </div>

    <div class="quiz-form-box">
      <h2 id="form-title">Create New Quiz</h2>
      <label for="quiz-title">Quiz Title:</label>
      <input type="text" id="quiz-title" placeholder="Quiz Title" />
      <label for="quiz-description">Quiz Description:</label>
      <textarea id="quiz-description" placeholder="Quiz Description" rows="3"></textarea>

      <label for="quiz-category-select">Category:</label>
      <select id="quiz-category-select">
          <option value="">-- Select Category --</option>
          </select>

      <div id="questions-container"></div>
      <button class="add-btn" onclick="addQuestion()">+ Add Manual Question</button>
      <div class="form-actions">
          <button id="submit-quiz-btn" class="add-btn" onclick="submitQuiz()">Save Quiz</button>
          <button id="cancel-edit-btn" class="add-btn" style="display: none; background-color: #7f8c8d;" onclick="cancelEdit()">Cancel Edit</button>
      </div>
    </div>

    <h2>Existing Quizzes</h2>
    <div id="quiz-list"></div>
  </div>

  <div id="aiQuizTab" class="tab-content">
    <div class="admin-section-box">
      <h2>AI Quiz Generator</h2>
      <div class="api-key-warning">
        <strong>Security Warning:</strong> For development/personal use, you can enter your API key below.
        For a production application accessible by others, **never expose your API key directly in client-side code.**
        Use a backend proxy (like Firebase Functions) to handle API calls securely.
        **Do NOT commit your API key to version control (Git).**
      </div>
      <label for="ai-api-key">Your AI Model API Key (e.g., Google Gemini API Key):</label>
      <input type="password" id="ai-api-key" placeholder="Paste your AI API Key here">

      <label for="ai-api-endpoint">AI API Endpoint URL (e.g., for Gemini):</label>
      <input type="text" id="ai-api-endpoint" placeholder="https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent">

      <label for="ai-quiz-topic">Topic for AI Quiz:</label>
      <input type="text" id="ai-quiz-topic" placeholder="e.g., The Renaissance, Basic Algebra">

      <label for="ai-source-text">Source Text (Optional, but Recommended for better results):</label>
      <textarea id="ai-source-text" rows="5" placeholder="Paste an article or notes for the AI to base questions on..."></textarea>

      <label for="ai-num-questions">Number of Questions to Generate:</label>
      <input type="number" id="ai-num-questions" value="5" min="1" max="15">
      <button id="generate-ai-quiz-btn" class="generate-btn" onclick="generateAIQuiz()">Generate Quiz with AI</button>

      <div id="ai-review-container" style="margin-top: 20px;"></div>

      <div id="ai-destination-options" style="display:none;">
        <h4>Where to save these AI questions?</h4>
        <label for="ai-quiz-category-select">Category for New AI Quiz:</label>
        <select id="ai-quiz-category-select">
            <option value="">-- Select Category --</option>
            </select>

        <div class="radio-group">
            <input type="radio" name="aiQuizDestination" id="ai-create-new-quiz-radio" value="new" checked onchange="toggleAIDestinationFields()">
            <label for="ai-create-new-quiz-radio">Create a New Quiz</label>
        </div>
        <div id="ai-new-quiz-fields">
          <label for="ai-new-quiz-title">New Quiz Title:</label>
          <input type="text" id="ai-new-quiz-title" placeholder="Enter title for new AI quiz">
          <label for="ai-new-quiz-description">New Quiz Description:</label>
          <textarea id="ai-new-quiz-description" rows="2" placeholder="Enter description"></textarea>
        </div>
        <div class="radio-group">
            <input type="radio" name="aiQuizDestination" id="ai-add-to-existing-quiz-radio" value="existing" onchange="toggleAIDestinationFields()">
            <label for="ai-add-to-existing-quiz-radio">Add to an Existing Quiz</label>
        </div>
        <div id="ai-existing-quiz-fields" style="display:none;">
          <label for="ai-existing-quiz-select">Select Quiz:</label>
          <select id="ai-existing-quiz-select">
            <option value="">-- Select an Existing Quiz --</option>
          </select>
        </div>
      </div>
      <button id="process-approved-ai-btn" class="add-btn" style="display:none; margin-top:10px;" onclick="handleApprovedAIQuestions()">Process Approved Questions</button>
    </div>
  </div>


  <div id="custom-popup" class="popup-overlay">
    <div class="popup-box">
      <p id="popup-message">Popup Message</p>
      <button onclick="closePopup()">OK</button>
    </div>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.7.1/firebase-app.js";
    import {
      getFirestore, collection, addDoc, deleteDoc,
      doc, getDoc, getDocs, updateDoc, orderBy, query
    } from "https://www.gstatic.com/firebasejs/11.7.1/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyDm788npk4qw9RcT7qevq2HPH5-DbSTq2k", // Replace with your actual Firebase API key
      authDomain: "location-45133.firebaseapp.com",
      projectId: "location-45133",
      storageBucket: "location-45133.appspot.com",
      messagingSenderId: "938504563570",
      appId: "1:938504563570:web:a4741a9f52b9795f304beb"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    // DOM Elements for Manual Quiz Form
    const questionsContainer = document.getElementById("questions-container");
    const titleInput = document.getElementById("quiz-title");
    const descInput = document.getElementById("quiz-description");
    const quizCategorySelect = document.getElementById("quiz-category-select");
    const formTitle = document.getElementById("form-title");
    const submitQuizBtn = document.getElementById("submit-quiz-btn");
    const cancelEditBtn = document.getElementById("cancel-edit-btn");
    const quizListDiv = document.getElementById("quiz-list");

    // DOM Elements for Category Management
    const categoryFormTitle = document.getElementById("category-form-title");
    const categoryIdInput = document.getElementById("category-id");
    const categoryNameInput = document.getElementById("category-name");
    const categoryIconInput = document.getElementById("category-icon-class");
    const categoryImageInput = document.getElementById("category-image-url");
    const categoryColorInput = document.getElementById("category-color");
    const categoryOrderInput = document.getElementById("category-order");
    const categoryListDiv = document.getElementById("category-list");

    // DOM Elements for AI Quiz Generator
    const aiApiKeyInput = document.getElementById("ai-api-key");
    const aiApiEndpointInput = document.getElementById("ai-api-endpoint");
    const aiQuizTopicInput = document.getElementById("ai-quiz-topic");
    const aiSourceTextInput = document.getElementById("ai-source-text");
    const aiNumQuestionsInput = document.getElementById("ai-num-questions");
    const generateAIQuizBtn = document.getElementById("generate-ai-quiz-btn");
    const aiReviewContainer = document.getElementById("ai-review-container");
    const processApprovedAIBtn = document.getElementById("process-approved-ai-btn");
    const aiDestinationOptionsDiv = document.getElementById("ai-destination-options");
    const aiNewQuizFieldsDiv = document.getElementById("ai-new-quiz-fields");
    const aiExistingQuizFieldsDiv = document.getElementById("ai-existing-quiz-fields");
    const aiNewQuizTitleInput = document.getElementById("ai-new-quiz-title");
    const aiNewQuizDescInput = document.getElementById("ai-new-quiz-description");
    const aiExistingQuizSelect = document.getElementById("ai-existing-quiz-select");
    const aiQuizCategorySelect = document.getElementById("ai-quiz-category-select");


    let editingQuizId = null;
    let editingCategoryId = null;
    let questionCounter = 0;

    // --- Tab Navigation ---
    window.openTab = function(evt, tabName) {
      let i, tabcontent, tabbuttons;
      tabcontent = document.getElementsByClassName("tab-content");
      for (i = 0; i < tabcontent.length; i++) {
        tabcontent[i].style.display = "none";
      }
      tabbuttons = document.getElementsByClassName("tab-button");
      for (i = 0; i < tabbuttons.length; i++) {
        tabbuttons[i].className = tabbuttons[i].className.replace(" active", "");
      }
      document.getElementById(tabName).style.display = "block";
      const targetButton = evt ? evt.currentTarget : document.getElementById('defaultOpenTab');
       if (targetButton) {
            // Ensure no other button has active class before adding it
            for (let btn of tabbuttons) {
                btn.classList.remove("active");
            }
            targetButton.classList.add("active");
        }
    }
    document.getElementById("defaultOpenTab").click();


    // --- Category Management Functions ---
    async function loadCategoriesAdmin() {
        categoryListDiv.innerHTML = "";
        try {
            // MODIFICATION: Removed orderBy("order", "asc")
            const q = query(collection(db, "categories"), orderBy("name", "asc"));
            const querySnapshot = await getDocs(q);
            if (querySnapshot.empty) {
                categoryListDiv.innerHTML = '<p class="empty-list-message">No categories created yet.</p>';
            } else {
                querySnapshot.forEach(docSnap => {
                    const category = docSnap.data();
                    const item = document.createElement('div');
                    item.className = 'category-list-item';
                    // Display order if it exists, otherwise N/A
                    const displayOrder = (category.order !== undefined && category.order !== null) ? category.order : 'N/A';
                    item.innerHTML = `
                        <span>
                            <strong>${category.name}</strong>
                            <small>(Order: ${displayOrder}, Color: ${category.color || 'N/A'})</small><br>
                            <small>Icon: ${category.iconClass || 'N/A'}, Image: ${category.imageUrl ? 'Yes' : 'No'}</small>
                        </span>
                        <div>
                            <button class="edit-category-btn" onclick="editCategoryAdmin('${docSnap.id}', '${category.name}', '${category.iconClass || ''}', '${category.imageUrl || ''}', '${category.color || ''}', ${displayOrder === 'N/A' ? null : displayOrder })">Edit</button>
                            <button class="delete-category-btn" onclick="deleteCategoryAdmin('${docSnap.id}', '${category.name}')">Delete</button>
                        </div>
                    `; // Pass null for order if N/A for edit function
                    categoryListDiv.appendChild(item);
                });
            }
        } catch (error) {
            console.error("Error loading categories for admin: ", error);
            categoryListDiv.innerHTML = '<p class="empty-list-message" style="color:red;">Could not load categories.</p>';
        }
        populateCategoryDropdowns();
    }

    window.saveCategory = async function() { /* ... (same as provided in the previous response, no changes needed here for this specific request) ... */ const name=categoryNameInput.value.trim();const iconClass=categoryIconInput.value.trim()||null;const imageUrl=categoryImageInput.value.trim()||null;const color=categoryColorInput.value.trim()||null;const orderStr=categoryOrderInput.value.trim();const order=orderStr?parseInt(orderStr,10):null;if(!name){showPopup("Category name is required.");return;}const categoryData={name};if(iconClass)categoryData.iconClass=iconClass;if(imageUrl)categoryData.imageUrl=imageUrl;if(color)categoryData.color=color;if(order!==null&&!isNaN(order))categoryData.order=order;const saveBtn=document.getElementById('save-category-btn');saveBtn.disabled=true;saveBtn.textContent="Saving...";try{if(editingCategoryId){await updateDoc(doc(db,"categories",editingCategoryId),categoryData);showPopup("Category updated successfully!");}else{await addDoc(collection(db,"categories"),categoryData);showPopup("Category added successfully!");}clearCategoryForm();loadCategoriesAdmin();}catch(error){console.error("Error saving category: ",error);showPopup("Error saving category: "+error.message);}finally{saveBtn.disabled=false;saveBtn.textContent="Save Category";}};
    window.editCategoryAdmin = function(id, name, icon, imageUrl, color, order) { /* ... (same) ... */ editingCategoryId=id;categoryNameInput.value=name;categoryIconInput.value=icon==='null'?'':icon;categoryImageInput.value=imageUrl==='null'?'':imageUrl;categoryColorInput.value=color==='null'?'':color;categoryOrderInput.value=order===null?'':order;categoryFormTitle.textContent="Edit Category";document.getElementById('save-category-btn').textContent="Update Category";categoryNameInput.focus();};
    window.deleteCategoryAdmin = async function(id, name) { /* ... (same) ... */ if(confirm(`Are you sure you want to delete the category "${name}"? This might affect quizzes associated with it.`)){try{await deleteDoc(doc(db,"categories",id));showPopup(`Category "${name}" deleted.`);loadCategoriesAdmin();if(editingCategoryId===id)clearCategoryForm();}catch(error){console.error("Error deleting category:",error);showPopup("Error deleting category: "+error.message);}}};
    window.clearCategoryForm = function() { /* ... (same) ... */ editingCategoryId=null;categoryIdInput.value="";categoryNameInput.value="";categoryIconInput.value="";categoryImageInput.value="";categoryColorInput.value="";categoryOrderInput.value="";categoryFormTitle.textContent="Add New Category";document.getElementById('save-category-btn').textContent="Save Category";};
    async function populateCategoryDropdowns() { /* ... (same) ... */ const dropdowns=[quizCategorySelect,aiQuizCategorySelect];dropdowns.forEach(dd=>{if(dd){const currentVal=dd.value;dd.innerHTML='<option value="">-- Select Category --</option>';}});try{const q=query(collection(db,"categories"),orderBy("name","asc"));const querySnapshot=await getDocs(q);querySnapshot.forEach(docSnap=>{const category=docSnap.data();dropdowns.forEach(dd=>{if(dd){const option=document.createElement('option');option.value=category.name;option.textContent=category.name;dd.appendChild(option);}});});dropdowns.forEach(dd=>{if(dd&&dd.querySelector(`option[value="${dd.value}"]`)){/* Keep current val if still valid, already handled by default select behavior or set explicitly where needed */} else if (dd.options.length > 1 && dd.value === "") { /* Optionally set a default if nothing was selected and options exist */}}); }catch(error){console.error("Error populating category dropdowns:",error);}};

    // --- AI Quiz Generation Functions ---
    window.generateAIQuiz = async function() { /* ... (same as provided previously, uses aiApiKeyInput.value and aiApiEndpointInput.value) ... */ const apiKey=aiApiKeyInput.value.trim();const apiEndpoint=aiApiEndpointInput.value.trim();const topic=aiQuizTopicInput.value.trim();const sourceText=aiSourceTextInput.value.trim();const numQuestions=parseInt(aiNumQuestionsInput.value,10);if(!apiKey){showPopup("Please enter your AI Model API Key.");return;}if(!apiEndpoint){showPopup("Please enter the AI API Endpoint URL.");return;}if(!topic){showPopup("Please enter a topic for the AI quiz.");return;}if(isNaN(numQuestions)||numQuestions<1||numQuestions>15){showPopup("Valid number of questions (1-15).");return;}generateAIQuizBtn.disabled=true;generateAIQuizBtn.textContent="Generating...";aiReviewContainer.innerHTML='<p>Generating questions...</p>';processApprovedAIBtn.style.display="none";aiDestinationOptionsDiv.style.display="none";let promptText=`Generate ${numQuestions} unique multiple-choice quiz questions about: "${topic}". Each question: 4 distinct options. One correct answer. Output: valid JSON array of objects. Each object keys: "questionText" (string), "options" (array of 4 strings), "correctAnswer" (string matching an option). Example: {"questionText": "Capital of France?","options": ["Paris","London","Berlin","Rome"],"correctAnswer": "Paris"}`;if(sourceText){promptText+=`\n\nBase on text:\n"${sourceText}"`;}let finalApiEndpoint=apiEndpoint;try{const requestBody={"contents":[{"parts":[{"text":promptText}]}],"generationConfig":{"temperature":0.7,"maxOutputTokens":2048}};const response=await fetch(finalApiEndpoint,{method:'POST',headers:{'Content-Type':'application/json','x-goog-api-key':apiKey},body:JSON.stringify(requestBody)});if(!response.ok){const errorData=await response.json().catch(()=>response.text());console.error("AI API Error:",errorData);throw new Error(`AI API failed: ${response.status}`);}const data=await response.json();const generatedQuestions=parseGeminiAIResponse(data);if(generatedQuestions&&generatedQuestions.length>0){displayAIQuestionsForReview(generatedQuestions);await populateExistingQuizzesDropdown();aiDestinationOptionsDiv.style.display="block";processApprovedAIBtn.style.display="block";toggleAIDestinationFields();}else{aiReviewContainer.innerHTML='<p style="color:orange;">AI returned no questions or in unexpected format.</p>';console.warn("Raw AI Response:",data);}}catch(error){console.error('Error AI quiz:',error);showPopup(`Error with AI: ${error.message}.`);aiReviewContainer.innerHTML='<p style="color:red;">Error. Check console.</p>';}finally{generateAIQuizBtn.disabled=false;generateAIQuizBtn.textContent="Generate Quiz with AI";}};
    function parseGeminiAIResponse(apiResponse) { /* ... (same) ... */ try{if(apiResponse.candidates&&apiResponse.candidates[0]&&apiResponse.candidates[0].content&&apiResponse.candidates[0].content.parts&&apiResponse.candidates[0].content.parts[0]&&apiResponse.candidates[0].content.parts[0].text){let jsonString=apiResponse.candidates[0].content.parts[0].text;jsonString=jsonString.replace(/^```json\s*|```\s*$/g,'').trim();const parsedJson=JSON.parse(jsonString);if(Array.isArray(parsedJson)){return parsedJson.map(q=>({questionText:q.questionText||q.question||"",options:Array.isArray(q.options)&&q.options.length===4?q.options:["","","",""],correctAnswer:q.correctAnswer||q.answer||""})).filter(q=>q.questionText&&q.options.every(opt=>opt!==undefined)&&q.correctAnswer);}}console.error("Unexpected AI JSON structure:",apiResponse);return [];}catch(e){console.error("Error parsing AI JSON:",e,"Raw text:",apiResponse?.candidates?.[0]?.content?.parts?.[0]?.text);showPopup("AI data not in expected JSON. See console.");return [];}}
    function displayAIQuestionsForReview(questions) { /* ... (same) ... */ aiReviewContainer.innerHTML='<h3>Review AI-Generated Questions:</h3> <p>Edit as needed and check "Keep" for questions to use.</p>';questions.forEach((q,index)=>{const rId=`ai-q-${index}`;const iD=document.createElement('div');iD.className='ai-review-item';iD.id=rId;const uSId=`ai-answer-select-${index}`;iD.innerHTML=`<h4>Question ${index+1} (AI)</h4><div class="ai-review-item-content"><label for="${rId}-text">Question Text:</label><input type="text" id="${rId}-text" class="ai-q-text" value="${q.questionText||''}"><label>Options:</label>${(q.options||["","","",""]).map((o,oI)=>`<div class="option-input-group"><input type="text" class="ai-q-option" value="${o||''}" placeholder="Option ${oI+1}" oninput="updateAnswerDropdown(this.closest('.ai-review-item'))"></div>`).join('')}<label for="${uSId}">Correct Answer:</label><select class="ai-q-answer answer-select" id="${uSId}"><option value="">-- Select --</option></select><input type="checkbox" id="${rId}-keep" class="ai-q-keep" checked><label for="${rId}-keep" class="keep-question-label">Keep</label></div>`;aiReviewContainer.appendChild(iD);updateAnswerDropdown(iD);const aS=iD.querySelector('.answer-select');const tCA=(q.correctAnswer||"").trim();const tO=(q.options||[]).map(o=>(o||"").trim());if(tCA&&tO.includes(tCA)){aS.value=tCA;}else if(q.correctAnswer){console.warn(`AI ans "${q.correctAnswer}" for Q${index+1} not in options.`);}}); }
    async function populateExistingQuizzesDropdown() { /* ... (same) ... */ aiExistingQuizSelect.innerHTML='<option value="">-- Select Quiz --</option>';try{const qS=await getDocs(collection(db,"quizzes"));if(qS.empty){const o=document.createElement('option');o.value="";o.textContent="No existing quizzes";o.disabled=true;aiExistingQuizSelect.appendChild(o);document.getElementById('ai-add-to-existing-quiz-radio').disabled=true;if(document.getElementById('ai-add-to-existing-quiz-radio').checked){document.getElementById('ai-create-new-quiz-radio').checked=true;toggleAIDestinationFields();}}else{document.getElementById('ai-add-to-existing-quiz-radio').disabled=false;qS.forEach(dS=>{const q=dS.data();const o=document.createElement('option');o.value=dS.id;o.textContent=q.title||"Untitled";aiExistingQuizSelect.appendChild(o);});}}catch(e){console.error("Err loading existing quizzes:",e);showPopup("Could not load existing quizzes.");}}
    window.toggleAIDestinationFields = function() { /* ... (same) ... */ if(document.getElementById('ai-create-new-quiz-radio').checked){aiNewQuizFieldsDiv.style.display="block";aiExistingQuizFieldsDiv.style.display="none";}else{aiNewQuizFieldsDiv.style.display="none";aiExistingQuizFieldsDiv.style.display="block";}}
    window.handleApprovedAIQuestions = async function() { /* ... (same, ensures aiQuizCategorySelect.value is used for new AI quizzes) ... */ const rIs=aiReviewContainer.querySelectorAll('.ai-review-item');const aQs=[];rIs.forEach((i,idx)=>{const kC=i.querySelector('.ai-q-keep');if(kC&&kC.checked){const qT=i.querySelector('.ai-q-text').value.trim();const o=Array.from(i.querySelectorAll('.ai-q-option')).map(opt=>opt.value.trim());const cA=i.querySelector('.ai-q-answer').value;if(!qT||o.some(op=>!op)||o.length!==4||!cA){showPopup(`Skipping incomplete AI Q${idx+1}.`);return;}aQs.push({question:qT,options:o,answer:cA});}});if(aQs.length===0){showPopup("No AI questions approved.");return;}const dest=document.querySelector('input[name="aiQuizDestination"]:checked').value;const selAICat=aiQuizCategorySelect.value;if(dest==="new"&&!selAICat){showPopup("Select category for new AI quiz.");return;}processApprovedAIBtn.disabled=true;processApprovedAIBtn.textContent="Processing...";try{if(dest==="new"){const nT=aiNewQuizTitleInput.value.trim();const nD=aiNewQuizDescInput.value.trim();if(!nT||!nD){showPopup("New quiz title & desc required.");return;}await addDoc(collection(db,"quizzes"),{title:nT,description:nD,category:selAICat,questions:aQs});showPopup(`New quiz "${nT}" created with ${aQs.length} Qs in category "${selAICat}".`);aiNewQuizTitleInput.value="";aiNewQuizDescInput.value="";}else if(dest==="existing"){const sQId=aiExistingQuizSelect.value;if(!sQId){showPopup("Select existing quiz.");return;}const qDR=doc(db,"quizzes",sQId);const qDS=await getDoc(qDR);if(!qDS.exists()){showPopup("Selected quiz not found.");return;}const eD=qDS.data();const cQs=[...(eD.questions||[]),...aQs];await updateDoc(qDR,{questions:cQs});showPopup(`Added ${aQs.length} AI Qs to "${eD.title}".`);}aiReviewContainer.innerHTML="";aiDestinationOptionsDiv.style.display="none";processApprovedAIBtn.style.display="none";loadQuizzes();}catch(e){console.error("Err processing AI Qs:",e);showPopup("Error saving AI Qs: "+e.message);}finally{processApprovedAIBtn.disabled=false;processApprovedAIBtn.textContent="Process Approved Questions";}};

    // --- Manual Quiz Form Functions (Adapted for Category) ---
    window.updateAnswerDropdown = function (questionBlockContainer) { /* ... (same) ... */ const oI=questionBlockContainer.querySelectorAll(".option,.ai-q-option");const aS=questionBlockContainer.querySelector(".answer-select,.ai-q-answer");if(!aS)return;const pSA=aS.value;aS.innerHTML='<option value="">-- Select --</option>';let aOMP=false;oI.forEach(oIn=>{const oT=oIn.value.trim();if(oT){const oE=document.createElement("option");oE.value=oT;oE.textContent=oT;aS.appendChild(oE);if(oT===pSA){oE.selected=true;aOMP=true;}}});if(aOMP){aS.value=pSA;}else{aS.value="";}};
    window.addQuestion = function () { /* ... (same) ... */ questionCounter++;const qNUI=questionsContainer.children.length+1;const d=document.createElement("div");d.className="question-block";d.id=`question-manual-${questionCounter}`;const h=document.createElement("div");h.className="accordion-header";h.innerHTML=`<span class="accordion-icon" style="transform:rotate(0deg);">►</span> Question ${qNUI}`;const c=document.createElement("div");c.className="question-content";c.innerHTML=`<input type="text" class="question-text" placeholder="Enter question"><label>Options:</label><div class="option-input-group"><input type="text" placeholder="Option A" class="option" oninput="updateAnswerDropdown(this.closest('.question-block'))"></div><div class="option-input-group"><input type="text" placeholder="Option B" class="option" oninput="updateAnswerDropdown(this.closest('.question-block'))"></div><div class="option-input-group"><input type="text" placeholder="Option C" class="option" oninput="updateAnswerDropdown(this.closest('.question-block'))"></div><div class="option-input-group"><input type="text" placeholder="Option D" class="option" oninput="updateAnswerDropdown(this.closest('.question-block'))"></div><label for="answer-select-manual-${questionCounter}">Correct Answer:</label><select class="answer-select" id="answer-select-manual-${questionCounter}"><option value="">-- Select --</option></select><button class="remove-btn" onclick="removeQuestionBlock(this)">Remove Question</button>`;h.addEventListener("click",()=>{const iA=h.classList.toggle("active");c.style.display=iA?"block":"none";h.querySelector('.accordion-icon').style.transform=iA?"rotate(90deg)":"rotate(0deg)";});d.appendChild(h);d.appendChild(c);questionsContainer.appendChild(d);c.style.display="block";h.classList.add("active");h.querySelector('.accordion-icon').style.transform="rotate(90deg)";updateAnswerDropdown(d);};
    window.removeQuestionBlock = function(buttonEl) { /* ... (same, ensure robust renumbering) ... */ buttonEl.closest('.question-block').remove();const qBs=questionsContainer.querySelectorAll('.question-block');qBs.forEach((b,i)=>{const h=b.querySelector('.accordion-header');const iS=h.querySelector('.accordion-icon');if(iS&&iS.nextSibling&&iS.nextSibling.nodeType===Node.TEXT_NODE){iS.nextSibling.nodeValue=` Question ${i+1}`;}else if(iS){h.innerHTML=iS.outerHTML+` Question ${i+1}`;}});};
    function clearForm() { /* ... (same + quizCategorySelect.value = "") ... */ titleInput.value="";descInput.value="";quizCategorySelect.value="";questionsContainer.innerHTML="";editingQuizId=null;formTitle.textContent="Create New Quiz";submitQuizBtn.textContent="Save Quiz";cancelEditBtn.style.display="none";questionCounter=0;aiReviewContainer.innerHTML="";aiDestinationOptionsDiv.style.display="none";processApprovedAIBtn.style.display="none";}
    window.cancelEdit = function() { clearForm(); }

    window.submitQuiz = async function () { /* ... (same, but includes quizCategorySelect.value) ... */ const title=titleInput.value.trim();const description=descInput.value.trim();const category=quizCategorySelect.value;const questionBlocks=questionsContainer.querySelectorAll(".question-block");if(!title){showPopup("Quiz title required.");return;}if(!description){showPopup("Quiz description required.");return;}if(!category){showPopup("Select a category.");return;}if(questionBlocks.length===0){showPopup("Add at least one question.");return;}const questions=[];for(let i=0;i<questionBlocks.length;i++){const b=questionBlocks[i];const qT=b.querySelector(".question-text").value.trim();const o=Array.from(b.querySelectorAll(".option")).map(op=>op.value.trim());const a=b.querySelector(".answer-select").value;const qNE=i+1;if(!qT){showPopup(`Q text missing (Q${qNE}).`);return;}if(o.some(op=>!op)||o.length!==4){showPopup(`All 4 options required (Q${qNE}).`);return;}if(!a){showPopup(`Answer not selected (Q${qNE}).`);return;}questions.push({question:qT,options:o,answer:a});}const quizData={title,description,category,questions};submitQuizBtn.disabled=true;submitQuizBtn.textContent=editingQuizId?'Updating...':'Saving...';try{if(editingQuizId){await updateDoc(doc(db,"quizzes",editingQuizId),quizData);showPopup("Quiz updated!");}else{await addDoc(collection(db,"quizzes"),quizData);showPopup("Quiz added!");}clearForm();loadQuizzes();}catch(e){console.error("Err saving quiz:",e);showPopup("Error saving quiz: "+e.message);}finally{submitQuizBtn.disabled=false;submitQuizBtn.textContent=document.getElementById("form-title").textContent==="Edit Quiz"?"Update Quiz":"Save Quiz";}};
    async function loadQuizzes() { /* ... (same, but displays category for each quiz) ... */ quizListDiv.innerHTML="";try{const qS=await getDocs(collection(db,"quizzes"));if(qS.empty){quizListDiv.innerHTML='<p class="empty-list-message">No quizzes found.</p>';return;}qS.forEach(dS=>{const d=dS.data();const qD=document.createElement("div");qD.className="existing-quiz-item";qD.innerHTML=`<h3>${d.title}</h3><p><em>Category: ${d.category||"N/A"}</em></p><p>${d.description?d.description.substring(0,100):''}${d.description&&d.description.length>100?'...':''}</p><p><strong>${d.questions?d.questions.length:0}</strong> Qs</p><div><button class="edit-quiz-btn" onclick="editQuiz('${dS.id}')">Edit</button><button class="delete-quiz-btn" onclick="deleteQuiz('${dS.id}')">Delete</button></div>`;quizListDiv.appendChild(qD);});}catch(e){console.error("Err loading quizzes:",e);quizListDiv.innerHTML='<p style="color:red;">Could not load quizzes.</p>';}};
    window.deleteQuiz = async function (id) { /* ... (same) ... */ if(confirm("Delete this quiz?")){try{await deleteDoc(doc(db,"quizzes",id));showPopup("Quiz deleted.");loadQuizzes();if(editingQuizId===id)clearForm();}catch(e){showPopup("Error deleting: "+e.message);}}};
    window.editQuiz = async function (id) { /* ... (same, but sets quizCategorySelect.value = data.category) ... */ openTab(null,'manualQuizTab');const fB=document.querySelector('.quiz-form-box');if(fB)fB.scrollIntoView({behavior:'smooth'});aiReviewContainer.innerHTML="";aiDestinationOptionsDiv.style.display="none";processApprovedAIBtn.style.display="none";try{const qDR=doc(db,"quizzes",id);const qDS=await getDoc(qDR);if(!qDS.exists()){showPopup("Quiz not found.");loadQuizzes();clearForm();return;}editingQuizId=id;formTitle.textContent="Edit Quiz";submitQuizBtn.textContent="Update Quiz";cancelEditBtn.style.display="inline-block";const d=qDS.data();titleInput.value=d.title||"";descInput.value=d.description||"";quizCategorySelect.value=d.category||"";questionsContainer.innerHTML="";questionCounter=0;if(d.questions&&Array.isArray(d.questions)){d.questions.forEach((q)=>{window.addQuestion();const nQBs=questionsContainer.querySelectorAll('.question-block');const tB=nQBs[nQBs.length-1];if(tB){tB.querySelector('.question-text').value=q.question||'';const oIs=tB.querySelectorAll('.option');const fOs=q.options&&q.options.length===4?q.options:["","","",""];oIs.forEach((inp,i)=>inp.value=fOs[i]||'');updateAnswerDropdown(tB);const aS=tB.querySelector('.answer-select');aS.value=q.answer||"";if(!aS.value&&q.answer){console.warn(`Loaded ans "${q.answer}" for Q "${q.question}" not in options.`);}const qC=tB.querySelector('.question-content');const qH=tB.querySelector('.accordion-header');const qI=qH.querySelector('.accordion-icon');if(questionsContainer.children.length>0){qC.style.display="none";qH.classList.remove('active');if(qI)qI.style.transform="rotate(0deg)";}else{qC.style.display="block";qH.classList.add('active');if(qI)qI.style.transform="rotate(90deg)";}}});}}catch(e){console.error("Error loading quiz for edit:",e);showPopup("Could not load quiz for edit: "+e.message);clearForm();}};

    window.showPopup = function(message) { document.getElementById("popup-message").innerText = message; document.getElementById("custom-popup").style.display = "flex"; };
    window.closePopup = function() { document.getElementById("custom-popup").style.display = "none"; };

    // Initial load
    loadCategoriesAdmin(); // Load categories for admin view (and populates dropdowns)
    loadQuizzes();
    toggleAIDestinationFields();
  </script>
</body>
</html>
