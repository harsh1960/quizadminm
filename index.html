<!DOCTYPE html>
<html>
<head>
  <title>Admin Panel - Manage Quizzes</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <style>
    body {
      font-family: 'Segoe UI', Roboto, Arial, sans-serif;
      padding: 20px;
      background: #f4f7f6;
      margin: 0;
      color: #333;
    }
    h2, h3 {
      color: #2c3e50;
      margin-top: 0; /* Adjust for tab content */
    }
    input, textarea, button, select {
      display: block;
      width: 100%;
      margin: 10px 0;
      padding: 12px;
      font-size: 16px;
      border-radius: 6px;
      border: 1px solid #ccc;
      box-sizing: border-box;
      transition: border-color 0.3s ease, box-shadow 0.3s ease;
    }
    input:focus, textarea:focus, select:focus {
      border-color: #3498db;
      box-shadow: 0 0 0 2px rgba(52, 152, 219, 0.2);
      outline: none;
    }
    .admin-section-box, .quiz-form-box, .question-block, .existing-quiz-item, .ai-review-item {
      background: #fff;
      padding: 20px;
      margin-bottom: 25px;
      border-radius: 8px;
      box-shadow: 0 4px 8px rgba(0,0,0,0.08);
    }
    .question-block, .ai-review-item {
        padding: 15px;
    }
    .option-input-group {
      display: flex;
      gap: 10px;
      align-items: center;
      margin-bottom: 8px;
    }
    .option-input-group input {
      flex: 1;
      margin: 0;
    }
    .remove-btn {
      background-color: #e74c3c;
      color: #fff;
      border: none;
      padding: 10px 15px;
      border-radius: 5px;
      cursor: pointer;
      font-size: 14px;
      transition: background-color 0.2s ease;
    }
    .remove-btn:hover { background-color: #c0392b; }

    .add-btn, .generate-btn {
      background-color: #3498db;
      color: #fff;
      border: none;
      padding: 12px 20px;
      margin-top: 15px;
      border-radius: 5px;
      font-size: 16px;
      cursor: pointer;
      transition: background-color 0.2s ease;
    }
    .add-btn:hover, .generate-btn:hover { background-color: #2980b9; }
    .add-btn:disabled, .generate-btn:disabled {
      background-color: #bdc3c7;
      cursor: not-allowed;
    }
    .generate-btn { background-color: #2ecc71; }
    .generate-btn:hover { background-color: #27ae60; }

    .form-actions {
        display: flex;
        gap: 10px;
        margin-top: 20px;
    }
    .form-actions button { flex-grow: 1; margin-top: 0; }

    .delete-quiz-btn, .edit-quiz-btn {
      background: #e74c3c; color: white; border: none; padding: 8px 14px;
      border-radius: 4px; cursor: pointer; margin-right: 10px; font-size: 14px;
      transition: background-color 0.2s ease;
    }
    .edit-quiz-btn { background-color: #2ecc71; }
    .delete-quiz-btn:hover { background-color: #c0392b; }
    .edit-quiz-btn:hover { background-color: #27ae60; }

    .accordion-header {
      cursor: pointer; padding: 12px 15px; background: #e9ecef;
      border-radius: 5px; font-weight: bold; display: flex; align-items: center;
      transition: background-color 0.2s ease;
    }
    .accordion-header:hover { background-color: #dee2e6; }
    .accordion-icon { margin-right: 10px; font-size: 1.1em; transition: transform 0.3s ease; }
    .accordion-header.active .accordion-icon { transform: rotate(90deg); }

    .question-content, .ai-review-item-content {
      display: none; padding: 15px; border: 1px solid #e9ecef;
      border-top: none; border-radius: 0 0 5px 5px;
    }
    .ai-review-item-content { display: block; }
    .ai-review-item label, .question-content label {
        font-weight: bold; margin-top: 10px; margin-bottom: 5px; display: block; color: #555;
    }
    .ai-review-item .keep-question-label { display: inline-block; margin-left: 5px; font-weight: normal; }
    .ai-review-item input[type="checkbox"] { width: auto; margin-right: 5px; vertical-align: middle; }

    .empty-list-message { text-align: center; color: #777; padding: 20px; font-style: italic; }
    .api-key-warning {
        color: #c0392b; font-weight: bold; background-color: #fceded;
        padding: 10px; border-radius: 5px; margin-bottom: 15px; border: 1px solid #e74c3c;
    }

    /* Tab Styles */
    .tab-navigation {
      border-bottom: 2px solid #ccc;
      margin-bottom: 20px;
      display: flex;
    }
    .tab-button {
      background-color: #f1f1f1;
      border: 1px solid #ccc;
      border-bottom: none;
      padding: 10px 20px;
      cursor: pointer;
      font-size: 16px;
      border-radius: 6px 6px 0 0;
      margin-right: 5px;
      margin-bottom: -1px; /* Overlap border */
      transition: background-color 0.3s ease;
      width: auto; /* Override general button width */
      margin-top: 0; /* Override general button margin */
    }
    .tab-button:hover { background-color: #ddd; }
    .tab-button.active {
      background-color: #fff;
      border-bottom: 2px solid #fff; /* Match background to hide bottom border */
      color: #3498db;
      font-weight: bold;
    }
    .tab-content { display: none; animation: fadeInEffect 0.5s; }
    @keyframes fadeInEffect { from {opacity: 0;} to {opacity: 1;} }


    @media (max-width: 600px) {
      .form-actions { flex-direction: column; }
      .tab-navigation { flex-direction: column; }
      .tab-button { width: 100%; margin-bottom: 5px; border-radius: 6px; }
      .tab-button.active { border-bottom: 1px solid #ccc; }

    }
    .popup-overlay { /* ... existing popup styles ... */ }
    .popup-box { /* ... existing popup styles ... */ }
    /* Minimal adjustments from previous provided CSS, mainly focus on tabs */
  </style>
</head>
<body>

  <div class="tab-navigation">
    <button id="defaultOpenTab" class="tab-button" onclick="openTab(event, 'manualQuizTab')">Manage & Create Quizzes</button>
    <button class="tab-button" onclick="openTab(event, 'aiQuizTab')">AI Quiz Generator</button>
  </div>

  <div id="manualQuizTab" class="tab-content">
    <div class="quiz-form-box">
      <h2 id="form-title">Create New Quiz</h2>
      <input type="text" id="quiz-title" placeholder="Quiz Title" />
      <textarea id="quiz-description" placeholder="Quiz Description" rows="3"></textarea>
      <div id="questions-container">
          </div>
      <button class="add-btn" onclick="addQuestion()">+ Add Manual Question</button>
      <div class="form-actions">
          <button id="submit-quiz-btn" class="add-btn" onclick="submitQuiz()">Save Quiz</button>
          <button id="cancel-edit-btn" class="add-btn" style="display: none; background-color: #7f8c8d;" onclick="cancelEdit()">Cancel Edit</button>
      </div>
    </div>

    <h2>Existing Quizzes</h2>
    <div id="quiz-list"></div>
  </div>

  <div id="aiQuizTab" class="tab-content">
    <div class="admin-section-box">
      <h2>AI Quiz Generator</h2>
      <div class="api-key-warning">
        <strong>Security Warning:</strong> For development/personal use, you can enter your API key below.
        For a production application accessible by others, **never expose your API key directly in client-side code.**
        Use a backend proxy (like Firebase Functions) to handle API calls securely.
        **Do NOT commit your API key to version control (Git).**
      </div>
      <label for="ai-api-key">Your AI Model API Key (e.g., Google Gemini API Key):</label>
      <input type="password" id="ai-api-key" placeholder="Paste your AI API Key here">

      <label for="ai-api-endpoint">AI API Endpoint URL (e.g., for Gemini):</label>
      <input type="text" id="ai-api-endpoint" placeholder="https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent">

      <label for="ai-quiz-topic">Topic for AI Quiz:</label>
      <input type="text" id="ai-quiz-topic" placeholder="e.g., The Renaissance, Basic Algebra">

      <label for="ai-source-text">Source Text (Optional, but Recommended for better results):</label>
      <textarea id="ai-source-text" rows="5" placeholder="Paste an article or notes for the AI to base questions on..."></textarea>

      <label for="ai-num-questions">Number of Questions to Generate:</label>
      <input type="number" id="ai-num-questions" value="5" min="1" max="15"> <button id="generate-ai-quiz-btn" class="generate-btn" onclick="generateAIQuiz()">Generate Quiz with AI</button>

      <div id="ai-review-container" style="margin-top: 20px;">
        </div>
      <button id="add-approved-ai-btn" class="add-btn" style="display:none; margin-top:10px;" onclick="addApprovedAIQuestionsToForm()">Add Approved Questions to Form</button>
    </div>
  </div>


  <div id="custom-popup" class="popup-overlay">
    <div class="popup-box">
      <p id="popup-message">Popup Message</p>
      <button onclick="closePopup()">OK</button>
    </div>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.7.1/firebase-app.js";
    import {
      getFirestore, collection, addDoc, deleteDoc,
      doc, getDoc, getDocs, updateDoc
    } from "https://www.gstatic.com/firebasejs/11.7.1/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyDm788npk4qw9RcT7qevq2HPH5-DbSTq2k", // Replace with your actual Firebase API key
      authDomain: "location-45133.firebaseapp.com",
      projectId: "location-45133",
      storageBucket: "location-45133.appspot.com",
      messagingSenderId: "938504563570",
      appId: "1:938504563570:web:a4741a9f52b9795f304beb"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    // DOM Elements for Manual Quiz Form
    const questionsContainer = document.getElementById("questions-container");
    const titleInput = document.getElementById("quiz-title");
    const descInput = document.getElementById("quiz-description");
    const formTitle = document.getElementById("form-title");
    const submitQuizBtn = document.getElementById("submit-quiz-btn");
    const cancelEditBtn = document.getElementById("cancel-edit-btn");
    const quizListDiv = document.getElementById("quiz-list");

    // DOM Elements for AI Quiz Generator
    const aiApiKeyInput = document.getElementById("ai-api-key");
    const aiApiEndpointInput = document.getElementById("ai-api-endpoint");
    const aiQuizTopicInput = document.getElementById("ai-quiz-topic");
    const aiSourceTextInput = document.getElementById("ai-source-text");
    const aiNumQuestionsInput = document.getElementById("ai-num-questions");
    const generateAIQuizBtn = document.getElementById("generate-ai-quiz-btn");
    const aiReviewContainer = document.getElementById("ai-review-container");
    const addApprovedAIBtn = document.getElementById("add-approved-ai-btn");


    let editingQuizId = null;
    let questionCounter = 0;

    // --- Tab Navigation ---
    window.openTab = function(evt, tabName) {
      let i, tabcontent, tabbuttons;
      tabcontent = document.getElementsByClassName("tab-content");
      for (i = 0; i < tabcontent.length; i++) {
        tabcontent[i].style.display = "none";
      }
      tabbuttons = document.getElementsByClassName("tab-button");
      for (i = 0; i < tabbuttons.length; i++) {
        tabbuttons[i].className = tabbuttons[i].className.replace(" active", "");
      }
      document.getElementById(tabName).style.display = "block";
      if (evt) evt.currentTarget.className += " active";
    }
    // Get the element with id="defaultOpenTab" and click on it
    document.getElementById("defaultOpenTab").click();


    // --- AI Quiz Generation Functions ---
    window.generateAIQuiz = async function() {
        const apiKey = aiApiKeyInput.value.trim();
        const apiEndpoint = aiApiEndpointInput.value.trim(); // User provides this
        const topic = aiQuizTopicInput.value.trim();
        const sourceText = aiSourceTextInput.value.trim();
        const numQuestions = parseInt(aiNumQuestionsInput.value, 10);

        if (!apiKey) { showPopup("Please enter your AI Model API Key."); return; }
        if (!apiEndpoint) { showPopup("Please enter the AI API Endpoint URL."); return; }
        if (!topic) { showPopup("Please enter a topic for the AI quiz."); return; }
        if (isNaN(numQuestions) || numQuestions < 1 || numQuestions > 15) {
            showPopup("Please enter a valid number of questions (1-15)."); return;
        }

        generateAIQuizBtn.disabled = true;
        generateAIQuizBtn.textContent = "Generating... Please Wait...";
        aiReviewContainer.innerHTML = '<p>Generating questions with AI... This may take a moment.</p>';
        addApprovedAIBtn.style.display = "none";

        // ** IMPORTANT: Customize this prompt for Google Gemini or your specific AI model! **
        // This prompt asks for JSON output directly.
        let promptText = `Generate ${numQuestions} unique multiple-choice quiz questions about the topic: "${topic}".
Each question should have exactly 4 distinct options.
Clearly indicate the single correct answer for each question.
Provide the output as a valid JSON array of objects. Each object in the array should represent a single question and have the following keys:
- "questionText": A string containing the question.
- "options": An array of 4 unique string options.
- "correctAnswer": A string that exactly matches one of the provided options.

Example of one object in the JSON array:
{
  "questionText": "What is the capital of France?",
  "options": ["Paris", "London", "Berlin", "Rome"],
  "correctAnswer": "Paris"
}
`;
        if (sourceText) {
            promptText += `\n\nBase the questions on the following text if possible:\n"${sourceText}"`;
        }

        // For Google Gemini API (keys from AI Studio), the key is often sent IN THE URL or as 'x-goog-api-key' header.
        // The endpoint URL from input should be like: https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent
        // The API key will be added to this URL if not already there.
        let finalApiEndpoint = apiEndpoint;
        if (!finalApiEndpoint.includes('?key=')) { // Check if key is already in URL
             // If using x-goog-api-key header, this isn't needed in URL. But for simplicity for user input,
             // let's assume they might provide URL with or without key. If using header method, key goes in header.
             // For this example, let's assume the key will be in the header if not in URL.
        }


        try {
            const requestBody = { // Structure for Gemini API
                "contents": [{
                    "parts": [{
                        "text": promptText
                    }]
                }],
                "generationConfig": { // Optional: customize generation
                    "temperature": 0.7,
                    "maxOutputTokens": 2048,
                    // "responseMimeType": "application/json", // If your model supports this, it's great!
                }
            };

            const response = await fetch(finalApiEndpoint, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    // For Gemini API keys from Google AI Studio:
                    'x-goog-api-key': apiKey
                    // If your API uses a Bearer token (less common for simple Gemini keys from AI Studio):
                    // 'Authorization': `Bearer ${apiKey}`
                },
                body: JSON.stringify(requestBody)
            });

            if (!response.ok) {
                const errorData = await response.json().catch(() => response.text());
                console.error("AI API Error Response:", errorData);
                throw new Error(`AI API request failed: ${response.status} ${response.statusText}.`);
            }

            const data = await response.json();
            const generatedQuestions = parseGeminiAIResponse(data); // Use Gemini specific parser

            if (generatedQuestions && generatedQuestions.length > 0) {
                displayAIQuestionsForReview(generatedQuestions);
                addApprovedAIBtn.style.display = "block";
            } else {
                aiReviewContainer.innerHTML = '<p style="color: orange;">AI did not return questions in the expected format, or returned no questions. Check console for API response.</p>';
                console.warn("Raw AI Response:", data);
            }

        } catch (error) {
            console.error('Error generating AI quiz:', error);
            showPopup(`Error generating quiz with AI: ${error.message}. Check console for details.`);
            aiReviewContainer.innerHTML = `<p style="color: red;">Error during AI generation. Check console.</p>`;
        } finally {
            generateAIQuizBtn.disabled = false;
            generateAIQuizBtn.textContent = "Generate Quiz with AI";
        }
    };

    // ** IMPORTANT: This function is specifically tailored for a Gemini API-like response
    // where the AI is prompted to return a JSON string within its text output. **
    function parseGeminiAIResponse(apiResponse) {
        try {
            // Gemini often returns the JSON string within candidates[0].content.parts[0].text
            if (apiResponse.candidates && apiResponse.candidates[0] &&
                apiResponse.candidates[0].content && apiResponse.candidates[0].content.parts &&
                apiResponse.candidates[0].content.parts[0] && apiResponse.candidates[0].content.parts[0].text) {

                let jsonString = apiResponse.candidates[0].content.parts[0].text;
                // Sometimes the JSON string might be wrapped in markdown ```json ... ```
                jsonString = jsonString.replace(/^```json\s*|```\s*$/g, '').trim();

                const parsedJson = JSON.parse(jsonString); // This is the array of question objects
                if (Array.isArray(parsedJson)) {
                    return parsedJson.map(q => ({
                        questionText: q.questionText || q.question || "",
                        options: Array.isArray(q.options) && q.options.length === 4 ? q.options : ["", "", "", ""],
                        correctAnswer: q.correctAnswer || q.answer || ""
                    }));
                }
            }
            console.error("Could not find expected JSON structure in AI response:", apiResponse);
            return [];
        } catch (e) {
            console.error("Error parsing JSON from AI response:", e, "Raw text:", apiResponse?.candidates?.[0]?.content?.parts?.[0]?.text);
            showPopup("AI returned data, but it was not in the expected JSON format. See console for details.");
            return [];
        }
    }


    function displayAIQuestionsForReview(questions) {
        aiReviewContainer.innerHTML = '<h3>Review AI-Generated Questions:</h3> <p>Edit as needed and check "Keep" for questions to add to the form.</p>';
        questions.forEach((q, index) => {
            const reviewItemId = `ai-q-${index}`;
            const itemDiv = document.createElement('div');
            itemDiv.className = 'ai-review-item';
            itemDiv.id = reviewItemId;
            const uniqueSelectId = `ai-answer-select-${index}`;

            itemDiv.innerHTML = `
                <h4>Question ${index + 1} (AI Generated)</h4>
                <div class="ai-review-item-content">
                    <label for="${reviewItemId}-text">Question Text:</label>
                    <input type="text" id="${reviewItemId}-text" class="ai-q-text" value="${q.questionText || ''}">
                    <label>Options:</label>
                    ${(q.options || ["","","",""]).map((opt, optIndex) => `
                        <div class="option-input-group">
                            <input type="text" class="ai-q-option" value="${opt || ''}" placeholder="Option ${optIndex + 1}" oninput="updateAnswerDropdown(this.closest('.ai-review-item'))">
                        </div>
                    `).join('')}
                    <label for="${uniqueSelectId}">Correct Answer:</label>
                    <select class="ai-q-answer answer-select" id="${uniqueSelectId}"> <option value="">-- Select --</option></select>
                    <input type="checkbox" id="${reviewItemId}-keep" class="ai-q-keep" checked>
                    <label for="${reviewItemId}-keep" class="keep-question-label">Keep this question</label>
                </div>`;
            aiReviewContainer.appendChild(itemDiv);
            updateAnswerDropdown(itemDiv);
            const answerSelect = itemDiv.querySelector('.answer-select');
            if (q.correctAnswer && (q.options || []).map(o => o.trim()).includes(q.correctAnswer.trim())) {
                 answerSelect.value = q.correctAnswer;
            } else if (q.correctAnswer) {
                console.warn(`AI answer "${q.correctAnswer}" for Q${index+1} not found in its provided options after trim. Manual selection needed.`);
            }
        });
    }

    window.addApprovedAIQuestionsToForm = function() {
        const reviewItems = aiReviewContainer.querySelectorAll('.ai-review-item');
        let questionsAddedCount = 0;
        reviewItems.forEach(item => {
            const keepCheckbox = item.querySelector('.ai-q-keep');
            if (keepCheckbox && keepCheckbox.checked) {
                const questionText = item.querySelector('.ai-q-text').value.trim();
                const options = Array.from(item.querySelectorAll('.ai-q-option')).map(opt => opt.value.trim());
                const correctAnswer = item.querySelector('.ai-q-answer').value;

                if (!questionText || options.some(o => !o) || options.length !== 4 || !correctAnswer) {
                    showPopup(`Skipping an incompletely reviewed AI question (Question ${Array.from(reviewItems).indexOf(item) + 1}). Ensure all fields are filled and answer selected.`);
                    return; // Skip this question
                }

                window.addQuestion(); // Creates an empty block in the main form
                const newQuestionBlocks = questionsContainer.querySelectorAll('.question-block');
                const targetBlock = newQuestionBlocks[newQuestionBlocks.length - 1];

                if (targetBlock) {
                    targetBlock.querySelector('.question-text').value = questionText;
                    const optionInputs = targetBlock.querySelectorAll('.option');
                    optionInputs.forEach((input, i) => input.value = options[i] || '');
                    updateAnswerDropdown(targetBlock);
                    targetBlock.querySelector('.answer-select').value = correctAnswer;
                    questionsAddedCount++;
                }
            }
        });

        if (questionsAddedCount > 0) {
            showPopup(`${questionsAddedCount} AI-generated question(s) added to the current quiz form.`);
            // Optionally switch to the manual quiz tab
            openTab(null, 'manualQuizTab');
            // Highlight the first newly added question or scroll to it
             if (questionsContainer.lastChild) {
                questionsContainer.lastChild.scrollIntoView({ behavior: 'smooth', block: 'center' });
                const header = questionsContainer.lastChild.querySelector('.accordion-header');
                if (header && !header.classList.contains('active')) {
                    header.click(); // Expand it
                }
            }

        } else {
            showPopup("No AI-generated questions were marked to be kept or none were complete.");
        }
        aiReviewContainer.innerHTML = "";
        addApprovedAIBtn.style.display = "none";
    };


    // --- Manual Quiz Form Functions ---
    function updateAnswerDropdown(questionBlockContainer) {
        const optionInputs = questionBlockContainer.querySelectorAll(".option, .ai-q-option");
        const answerSelect = questionBlockContainer.querySelector(".answer-select, .ai-q-answer");
        if (!answerSelect) return;

        const previouslySelectedAnswer = answerSelect.value;
        answerSelect.innerHTML = '<option value="">-- Select Correct Answer --</option>';
        let anOptionMatchedPrevious = false;

        optionInputs.forEach(optInput => {
            const optText = optInput.value.trim();
            if (optText) {
                const optionElement = document.createElement("option");
                optionElement.value = optText;
                optionElement.textContent = optText;
                answerSelect.appendChild(optionElement);
                if (optText === previouslySelectedAnswer) {
                    optionElement.selected = true;
                    anOptionMatchedPrevious = true;
                }
            }
        });
        if (anOptionMatchedPrevious) {
            answerSelect.value = previouslySelectedAnswer;
        } else {
            answerSelect.value = ""; // Default to placeholder if previous selection is no longer valid
        }
    }

    window.addQuestion = function () {
      questionCounter++;
      const questionNumberInUI = questionsContainer.children.length + 1;
      const div = document.createElement("div");
      div.className = "question-block";
      div.id = `question-manual-${questionCounter}`;
      const header = document.createElement("div");
      header.className = "accordion-header";
      header.innerHTML = `<span class="accordion-icon" style="transform: rotate(0deg);">►</span> Question ${questionNumberInUI}`;
      const content = document.createElement("div");
      content.className = "question-content";
      content.innerHTML = `
        <input type="text" class="question-text" placeholder="Enter question">
        <label>Options (Enter text for each):</label>
        <div class="option-input-group"><input type="text" placeholder="Option A" class="option" oninput="updateAnswerDropdown(this.closest('.question-block'))"></div>
        <div class="option-input-group"><input type="text" placeholder="Option B" class="option" oninput="updateAnswerDropdown(this.closest('.question-block'))"></div>
        <div class="option-input-group"><input type="text" placeholder="Option C" class="option" oninput="updateAnswerDropdown(this.closest('.question-block'))"></div>
        <div class="option-input-group"><input type="text" placeholder="Option D" class="option" oninput="updateAnswerDropdown(this.closest('.question-block'))"></div>
        <label for="answer-select-manual-${questionCounter}">Correct Answer:</label>
        <select class="answer-select" id="answer-select-manual-${questionCounter}">
            <option value="">-- Select Correct Answer --</option>
        </select>
        <button class="remove-btn" onclick="removeQuestionBlock(this)">Remove Question</button>`;
      header.addEventListener("click", () => {
        const isActive = header.classList.toggle("active");
        content.style.display = isActive ? "block" : "none";
        header.querySelector('.accordion-icon').style.transform = isActive ? "rotate(90deg)" : "rotate(0deg)";
      });
      div.appendChild(header);
      div.appendChild(content);
      questionsContainer.appendChild(div);
      content.style.display = "block";
      header.classList.add("active");
      header.querySelector('.accordion-icon').style.transform = "rotate(90deg)";
      updateAnswerDropdown(div);
    };

    window.removeQuestionBlock = function(buttonEl) {
        buttonEl.closest('.question-block').remove();
        const qBlocks = questionsContainer.querySelectorAll('.question-block');
        qBlocks.forEach((block, index) => {
            const header = block.querySelector('.accordion-header');
            const iconSpan = header.querySelector('.accordion-icon'); // Get the span itself
            // Preserve existing icon state by checking current transform directly
            const currentIconTransform = iconSpan.style.transform;
            header.innerHTML = `<span class="accordion-icon" style="transform: ${currentIconTransform};">►</span> Question ${index + 1}`;
             // Re-find the icon span to ensure style is applied if innerHTML was totally replaced.
            const newIconSpan = header.querySelector('.accordion-icon');
            if (newIconSpan) newIconSpan.style.transform = currentIconTransform; // Re-apply
            if (header.classList.contains('active')) { // Ensure ▼ if active
                 if(newIconSpan) newIconSpan.textContent = '▼'; // Or rotate correctly
                 if(newIconSpan) newIconSpan.style.transform = "rotate(90deg)";
            } else {
                 if(newIconSpan) newIconSpan.textContent = '►';
                 if(newIconSpan) newIconSpan.style.transform = "rotate(0deg)";
            }

        });
    }

    function clearForm() {
      titleInput.value = ""; descInput.value = ""; questionsContainer.innerHTML = "";
      editingQuizId = null; formTitle.textContent = "Create New Quiz";
      submitQuizBtn.textContent = "Save Quiz"; cancelEditBtn.style.display = "none";
      questionCounter = 0;
      aiReviewContainer.innerHTML = ""; addApprovedAIBtn.style.display = "none";
      // aiQuizTopicInput.value = ""; aiSourceTextInput.value = ""; // Optionally clear AI form too
    }

    window.cancelEdit = function() { clearForm(); }

    window.submitQuiz = async function () { /* ... existing submitQuiz logic ... */
      const title = titleInput.value.trim();
      const description = descInput.value.trim();
      const questionBlocks = questionsContainer.querySelectorAll(".question-block");

      if (!title) { showPopup("Please enter a quiz title."); return; }
      if (!description) { showPopup("Please enter a quiz description."); return; }
      if (questionBlocks.length === 0) { showPopup("Please add at least one question to the quiz form."); return; }

      const questions = [];
      for (let i = 0; i < questionBlocks.length; i++) {
        const block = questionBlocks[i];
        const qText = block.querySelector(".question-text").value.trim();
        const opts = Array.from(block.querySelectorAll(".option")).map(o => o.value.trim());
        const ans = block.querySelector(".answer-select").value;
        const questionNumberForError = i + 1;
        if (!qText) { showPopup(`Question text missing in Question ${questionNumberForError} of the form.`); return; }
        if (opts.some(o => !o) || opts.length !== 4) { showPopup(`All 4 options required for Question ${questionNumberForError} of the form.`); return; }
        if (!ans) { showPopup(`Correct answer not selected for Question ${questionNumberForError} of the form.`); return; }
        questions.push({ question: qText, options: opts, answer: ans });
      }

      const originalButtonText = submitQuizBtn.textContent;
      submitQuizBtn.disabled = true;
      submitQuizBtn.textContent = editingQuizId ? 'Updating...' : 'Saving...';

      try {
        if (editingQuizId) {
          await updateDoc(doc(db, "quizzes", editingQuizId), { title, description, questions });
          showPopup("Quiz updated successfully!");
        } else {
          await addDoc(collection(db, "quizzes"), { title, description, questions });
          showPopup("Quiz added successfully!");
        }
        clearForm();
        loadQuizzes();
      } catch (e) {
        console.error("Error saving quiz:", e);
        showPopup("Error saving quiz: " + e.message);
      } finally {
        submitQuizBtn.disabled = false;
        submitQuizBtn.textContent = formTitle.textContent === "Edit Quiz" ? "Update Quiz" : "Save Quiz";
      }
    };

    async function loadQuizzes() { /* ... existing loadQuizzes logic ... */
      quizListDiv.innerHTML = "";
      try {
        const querySnapshot = await getDocs(collection(db, "quizzes"));
        if (querySnapshot.empty) {
            quizListDiv.innerHTML = '<p class="empty-list-message">No quizzes found. Start by creating a new one!</p>';
            return;
        }
        querySnapshot.forEach(docSnap => {
          const data = docSnap.data();
          const quizDiv = document.createElement("div");
          quizDiv.className = "existing-quiz-item";
          quizDiv.innerHTML = `
            <h3>${data.title}</h3>
            <p>${data.description.substring(0,100)}${data.description.length > 100 ? '...' : ''}</p>
            <p><strong>${data.questions ? data.questions.length : 0}</strong> question(s)</p>
            <div>
                <button class="edit-quiz-btn" onclick="editQuiz('${docSnap.id}')">Edit</button>
                <button class="delete-quiz-btn" onclick="deleteQuiz('${docSnap.id}')">Delete</button>
            </div>`;
          quizListDiv.appendChild(quizDiv);
        });
      } catch (error) {
          console.error("Error loading quizzes:", error);
          quizListDiv.innerHTML = '<p class="empty-list-message" style="color: red;">Could not load quizzes.</p>';
      }
    }

    window.deleteQuiz = async function (id) { /* ... existing deleteQuiz logic ... */
      if (confirm("Are you sure you want to delete this quiz? This action cannot be undone.")) {
        try {
            await deleteDoc(doc(db, "quizzes", id));
            showPopup("Quiz deleted successfully.");
            loadQuizzes();
            if (editingQuizId === id) { clearForm(); }
        } catch (error) {
            console.error("Error deleting quiz:", error);
            showPopup("Error deleting quiz: " + error.message);
        }
      }
    };

    window.editQuiz = async function (id) { /* ... existing editQuiz logic, with UI adjustments for tabs ... */
      openTab(null, 'manualQuizTab'); // Ensure manual tab is active
      document.querySelector('.quiz-form-box').scrollIntoView({ behavior: 'smooth' });

      aiReviewContainer.innerHTML = ""; addApprovedAIBtn.style.display = "none"; // Clear AI section
      try {
        const quizDocRef = doc(db, "quizzes", id);
        const quizDoc = await getDoc(quizDocRef);
        if (!quizDoc.exists()) { showPopup("Quiz not found."); loadQuizzes(); return; }

        editingQuizId = id;
        formTitle.textContent = "Edit Quiz";
        submitQuizBtn.textContent = "Update Quiz";
        cancelEditBtn.style.display = "inline-block";

        const data = quizDoc.data();
        titleInput.value = data.title; descInput.value = data.description;
        questionsContainer.innerHTML = ""; questionCounter = 0;

        if (data.questions && Array.isArray(data.questions)) {
            data.questions.forEach((q) => {
              window.addQuestion();
              const newQuestionBlocks = questionsContainer.querySelectorAll('.question-block');
              const targetBlock = newQuestionBlocks[newQuestionBlocks.length - 1];
              if(targetBlock){
                  targetBlock.querySelector('.question-text').value = q.question || '';
                  const optionInputs = targetBlock.querySelectorAll('.option');
                  const formOptions = q.options && q.options.length === 4 ? q.options : ["", "", "", ""];
                  optionInputs.forEach((input, i) => input.value = formOptions[i] || '');
                  updateAnswerDropdown(targetBlock);
                  const answerSelect = targetBlock.querySelector('.answer-select');
                  answerSelect.value = q.answer || "";
                  if (!answerSelect.value && q.answer) { console.warn(`Loaded answer "${q.answer}" for Q "${q.question}" not found.`); }
                  
                  const qContent = targetBlock.querySelector('.question-content');
                  const qHeader = targetBlock.querySelector('.accordion-header');
                  const qIcon = qHeader.querySelector('.accordion-icon');
                  if (data.questions.length > 1) { // Collapse if more than one question
                    qContent.style.display = "none";
                    qHeader.classList.remove('active');
                    qIcon.style.transform = "rotate(0deg)";
                  } else { // Keep expanded if only one question
                    qContent.style.display = "block";
                    qHeader.classList.add('active');
                    qIcon.style.transform = "rotate(90deg)";
                  }
              }
            });
        }
      } catch (error) {
          console.error("Error loading quiz for editing:", error);
          showPopup("Could not load quiz for editing: " + error.message);
          clearForm();
      }
    };

    window.showPopup = function(message) { /* ... existing showPopup ... */
      document.getElementById("popup-message").innerText = message;
      document.getElementById("custom-popup").style.display = "flex";
    };
    window.closePopup = function() { /* ... existing closePopup ... */
      document.getElementById("custom-popup").style.display = "none";
    };

    loadQuizzes();
  </script>
</body>
</html>
